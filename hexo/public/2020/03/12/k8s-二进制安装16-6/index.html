<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文档介绍使用二进制部署  kubernetes v1.16.6  集群的所有步骤（Hard-Way模式）本系列系文档适用于  CentOS 7  及以上版本系统由于启用了  x509  证书双向认证、 RBAC  授权等严格的安全机制，建议从头开始部署，否则可能会认证、授权等失败！从 v1.16.x 版本开始，本文档做了如下调整：  容器运行时：用 containerd 替换 docker，更加">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s-二进制安装16.6">
<meta property="og:url" content="http://yoursite.com/2020/03/12/k8s-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%8516-6/index.html">
<meta property="og:site_name" content="Q&#39;s blog">
<meta property="og:description" content="本文档介绍使用二进制部署  kubernetes v1.16.6  集群的所有步骤（Hard-Way模式）本系列系文档适用于  CentOS 7  及以上版本系统由于启用了  x509  证书双向认证、 RBAC  授权等严格的安全机制，建议从头开始部署，否则可能会认证、授权等失败！从 v1.16.x 版本开始，本文档做了如下调整：  容器运行时：用 containerd 替换 docker，更加">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-03-12T14:47:45.000Z">
<meta property="article:modified_time" content="2020-03-14T06:40:27.608Z">
<meta property="article:author" content="屈辉">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2020/03/12/k8s-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%8516-6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>k8s-二进制安装16.6 | Q's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Q's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一些个人文档笔记</p>
  </div>

  <div class="site-nav-right"></div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">20</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">115</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Horus-K" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/12/k8s-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%8516-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="屈辉">
      <meta itemprop="description" content="开心就好">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Q's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s-二进制安装16.6
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-12 22:47:45" itemprop="dateCreated datePublished" datetime="2020-03-12T22:47:45+08:00">2020-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-14 14:40:27" itemprop="dateModified" datetime="2020-03-14T14:40:27+08:00">2020-03-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本文档介绍使用二进制部署  kubernetes v1.16.6  集群的所有步骤（Hard-Way模式）<br>本系列系文档适用于  CentOS 7  及以上版本系统<br>由于启用了  x509  证书双向认证、 RBAC  授权等严格的安全机制，建议从头开始部署，否则可能会认证、授权等失败！<br>从 v1.16.x 版本开始，本文档做了如下调整：</p>
<ul>
<li>容器运行时：用 containerd 替换 docker，更加简单、健壮；相应的命令行工具为crictl；</li>
<li>Pod 网络：用 calico 替换 flannel 实现 Pod 互通，支持更大规模的集群；新增指标监控系统：使用主流的 Prometheus、Grafana 技术栈实现集群指标采集和监控；如果想继续使用 docker 和 flannel，请参考附件文档。</li>
</ul>
<a id="more"></a>

<h1 id="组件版本和配置策略"><a href="#组件版本和配置策略" class="headerlink" title="组件版本和配置策略"></a>组件版本和配置策略</h1><h2 id="主要组件版本"><a href="#主要组件版本" class="headerlink" title="主要组件版本"></a>主要组件版本</h2><table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">版本</th>
</tr>
</thead>
<tbody><tr>
<td align="center">kubernetes</td>
<td align="center">1.16.6</td>
</tr>
<tr>
<td align="center">etcd</td>
<td align="center">3.4.3</td>
</tr>
<tr>
<td align="center">containerd</td>
<td align="center">1.3.3</td>
</tr>
<tr>
<td align="center">runc</td>
<td align="center">1.0.0-rc10</td>
</tr>
<tr>
<td align="center">calico</td>
<td align="center">3.12.0</td>
</tr>
<tr>
<td align="center">coredns</td>
<td align="center">1.6.6</td>
</tr>
<tr>
<td align="center">dashboard</td>
<td align="center">v2.0.0-rc4</td>
</tr>
<tr>
<td align="center">k8s-prometheus-adapter</td>
<td align="center">0.5.0</td>
</tr>
<tr>
<td align="center">prometheus-operator</td>
<td align="center">0.35.0</td>
</tr>
<tr>
<td align="center">prometheus</td>
<td align="center">2.15.2</td>
</tr>
<tr>
<td align="center">elasticsearch、kibana</td>
<td align="center">7.2.0</td>
</tr>
<tr>
<td align="center">cni-plugins</td>
<td align="center">0.8.5</td>
</tr>
<tr>
<td align="center">metrics-server</td>
<td align="center">0.3.6</td>
</tr>
</tbody></table>
<h2 id="主要配置策略"><a href="#主要配置策略" class="headerlink" title="主要配置策略"></a>主要配置策略</h2><h3 id="kube-apiserver："><a href="#kube-apiserver：" class="headerlink" title="kube-apiserver："></a>kube-apiserver：</h3><ul>
<li><p>使用节点本地 nginx 4 层透明代理实现高可用；</p>
</li>
<li><p>关闭非安全端口 8080 和匿名访问；</p>
</li>
<li><p>在安全端口 6443 接收 https 请求；</p>
</li>
<li><p>严格的认证和授权策略 (x509、token、RBAC)；</p>
</li>
<li><p>开启 bootstrap token 认证，支持 kubelet TLS bootstrapping；</p>
</li>
<li><p>使用 https 访问 kubelet、etcd，加密通信；</p>
<h3 id="kube-controller-manager："><a href="#kube-controller-manager：" class="headerlink" title="kube-controller-manager："></a>kube-controller-manager：</h3></li>
<li><p>3 节点高可用；</p>
</li>
<li><p>关闭非安全端口，在安全端口 10252 接收 https 请求；</p>
</li>
<li><p>使用 kubeconfig 访问 apiserver 的安全端口；</p>
</li>
<li><p>自动 approve kubelet 证书签名请求 (CSR)，证书过期后自动轮转；</p>
</li>
<li><p>各 controller 使用自己的 ServiceAccount 访问 apiserver；</p>
</li>
<li><p>kube-scheduler：</p>
</li>
<li><p>3 节点高可用；</p>
</li>
<li><p>使用 kubeconfig 访问 apiserver 的安全端口；</p>
<h3 id="kubelet："><a href="#kubelet：" class="headerlink" title="kubelet："></a>kubelet：</h3></li>
<li><p>使用 kubeadm 动态创建 bootstrap token，而不是在 apiserver 中静态配置；</p>
</li>
<li><p>使用 TLS bootstrap 机制自动生成 client 和 server 证书，过期后自动轮转；</p>
</li>
<li><p>在 KubeletConfiguration 类型的 JSON 文件配置主要参数；</p>
</li>
<li><p>关闭只读端口，在安全端口 10250 接收 https 请求，对请求进行认证和授权，拒绝</p>
</li>
<li><p>匿名访问和非授权访问；</p>
</li>
<li><p>使用 kubeconfig 访问 apiserver 的安全端口；</p>
<h3 id="kube-proxy："><a href="#kube-proxy：" class="headerlink" title="kube-proxy："></a>kube-proxy：</h3></li>
<li><p>使用 kubeconfig 访问 apiserver 的安全端口；</p>
</li>
<li><p>在 KubeProxyConfiguration 类型的 JSON 文件配置主要参数；</p>
</li>
<li><p>使用 ipvs 代理模式；</p>
<h3 id="集群插件："><a href="#集群插件：" class="headerlink" title="集群插件："></a>集群插件：</h3></li>
<li><p>DNS：使用功能、性能更好的 coredns；</p>
</li>
<li><p>Dashboard：支持登录认证；</p>
</li>
<li><p>Metric：metrics-server，使用 https 访问 kubelet 安全端口；</p>
</li>
<li><p>Log：Elasticsearch、Fluend、Kibana；</p>
</li>
<li><p>Registry 镜像库：docker-registry、harbor；</p>
</li>
</ul>
<h2 id="初始化系统和全局变量"><a href="#初始化系统和全局变量" class="headerlink" title="初始化系统和全局变量"></a>初始化系统和全局变量</h2><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><ul>
<li><p>zhangjun-k8s-01：172.27.138.251</p>
</li>
<li><p>zhangjun-k8s-02：172.27.137.229</p>
</li>
<li><p>zhangjun-k8s-03：172.27.138.239</p>
</li>
</ul>
<blockquote>
<p>三台机器混合部署本文档的 etcd、master 集群和 woker 集群。</p>
<p>如果没有特殊说明，需要在所有节点上执行本文档的初始化操作。</p>
</blockquote>
<h3 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-01 # 将 k8s-01 替换为当前主机名</span><br></pre></td></tr></table></figure>

<p>如果 DNS 不支持主机名称解析，还需要在每台机器的  /etc/hosts  文件中添加主机名和 IP 的对应关系：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">172.27.138.251 k8s-01</span><br><span class="line">172.27.137.229 k8s-02</span><br><span class="line">172.27.138.239 k8s-03</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>退出，重新登录 root 账号，可以看到主机名生效。</p>
<h3 id="添加节点信任关系"><a href="#添加节点信任关系" class="headerlink" title="添加节点信任关系"></a>添加节点信任关系</h3><p>本操作只需要在k8s-01 节点上进行，设置 root 账户可以无密码登录所有节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id root@k8s-01</span><br><span class="line">ssh-copy-id root@k8s-02</span><br><span class="line">ssh-copy-id root@k8s-03</span><br></pre></td></tr></table></figure>

<h3 id="更新-PATH-变量"><a href="#更新-PATH-变量" class="headerlink" title="更新 PATH 变量"></a>更新 PATH 变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 'PATH=/opt/k8s/bin:$PATH' &gt;&gt;/root/.bashrc</span><br><span class="line">source /root/.bashrc</span><br></pre></td></tr></table></figure>

<ul>
<li>/opt/k8s/bin  目录保存本文档下载安装的程序；</li>
</ul>
<h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line">yum install -y chrony conntrack ipvsadm ipset jq iptables curl sysstat libseccomp wget</span><br><span class="line">socat git</span><br></pre></td></tr></table></figure>

<ul>
<li>本文档的 kube-proxy 使用 ipvs 模式，ipvsadm 为 ipvs 的管理工具；</li>
<li>etcd 集群各机器需要时间同步，chrony 用于系统时间同步；</li>
</ul>
<h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><p>关闭防火墙，清理防火墙规则，设置默认转发策略：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure>

<h3 id="关闭-swap-分区"><a href="#关闭-swap-分区" class="headerlink" title="关闭 swap 分区"></a>关闭 swap 分区</h3><p>关闭 swap 分区，否则kubelet 会启动失败(可以设置 kubelet 启动参数 –fail-swap-on 为<br>false 关闭 swap 检查)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab</span><br></pre></td></tr></table></figure>

<h3 id="关闭-SELinux"><a href="#关闭-SELinux" class="headerlink" title="关闭 SELinux"></a>关闭 SELinux</h3><p>关闭 SELinux，否则 kubelet 挂载目录时可能报错  Permission denied  ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span><br></pre></td></tr></table></figure>

<h3 id="优化内核参数"><a href="#优化内核参数" class="headerlink" title="优化内核参数"></a>优化内核参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">net.ipv4.neigh.default.gc_thresh1=1024</span><br><span class="line">net.ipv4.neigh.default.gc_thresh1=2048</span><br><span class="line">net.ipv4.neigh.default.gc_thresh1=4096</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br><span class="line">cp kubernetes.conf /etc/sysctl.d/kubernetes.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭 tcp_tw_recycle，否则与 NAT 冲突，可能导致服务不通；</li>
</ul>
<h3 id="设置系统时区"><a href="#设置系统时区" class="headerlink" title="设置系统时区"></a>设置系统时区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure>

<h3 id="设置系统时钟同步"><a href="#设置系统时钟同步" class="headerlink" title="设置系统时钟同步"></a>设置系统时钟同步</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line">systemctl start chronyd</span><br></pre></td></tr></table></figure>

<h3 id="查看同步状态："><a href="#查看同步状态：" class="headerlink" title="查看同步状态："></a>查看同步状态：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl status</span><br></pre></td></tr></table></figure>

<h4 id="输出："><a href="#输出：" class="headerlink" title="输出："></a>输出：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System clock synchronized: yes</span><br><span class="line">NTP service: active</span><br><span class="line">RTC in local TZ: no</span><br></pre></td></tr></table></figure>

<ul>
<li>System clock synchronized: yes  ，表示时钟已同步；</li>
<li>NTP service: active  ，表示开启了时钟同步服务；</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 将当前的 UTC 时间写入硬件时钟</span></span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启依赖于系统时间的服务</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">systemctl restart crond</span><br></pre></td></tr></table></figure>

<p>关闭无关的服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop postfix &amp;&amp; systemctl disable postfix</span><br></pre></td></tr></table></figure>

<h3 id="创建相关目录"><a href="#创建相关目录" class="headerlink" title="创建相关目录"></a>创建相关目录</h3><h4 id="创建目录："><a href="#创建目录：" class="headerlink" title="创建目录："></a>创建目录：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/k8s/&#123;bin,work&#125; /etc/&#123;kubernetes,etcd&#125;/cert</span><br></pre></td></tr></table></figure>

<h3 id="创建环境变量文件"><a href="#创建环境变量文件" class="headerlink" title="创建环境变量文件"></a>创建环境变量文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NODE_IPS=("k8s-01" "k8s-02" "k8s-03"s)</span><br></pre></td></tr></table></figure>

<h3 id="分发集群配置参数脚本"><a href="#分发集群配置参数脚本" class="headerlink" title="分发集群配置参数脚本"></a>分发集群配置参数脚本</h3><p>后续使用的环境变量都定义在文件 <code>environment.sh</code> 中，请根据自己的机器、网络情况修<br>改。然后拷贝到所有节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source environment.sh # 先修改</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">scp environment.sh root@$&#123;node_ip&#125;:/opt/k8s/bin/</span><br><span class="line">ssh root@$&#123;node_ip&#125; "chmod +x /opt/k8s/bin/*"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="升级内核"><a href="#升级内核" class="headerlink" title="升级内核"></a>升级内核</h3><p>CentOS 7.x 系统自带的 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes不稳定，例如：</p>
<ol>
<li>高版本的 docker(1.13 以后) 启用了 3.10 kernel 实验支持的 kernel memoryaccount 功能(无法关闭)，当节点压力大如频繁启动和停止容器时会导致 cgroupmemory leak；</li>
<li>网络设备引用计数泄漏，会导致类似于报错：”kernel:unregister_netdevice: waitingfor eth0 to become free. Usage count = 1”;</li>
</ol>
<h4 id="解决方案如下："><a href="#解决方案如下：" class="headerlink" title="解决方案如下："></a>解决方案如下：</h4><ol>
<li><p>升级内核到 4.4.X 以上；</p>
</li>
<li><p>或者，手动编译内核，disable CONFIG_MEMCG_KMEM 特性；</p>
</li>
<li><p>或者，安装修复了该问题的 Docker 18.09.1 及以上的版本。但由于 kubelet 也会设置 kmem（它 vendor 了runc），所以需要重新编译 kubelet 并指定 GOFLAGS=”-tags=nokmem”；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone --branch v1.14.1 --single-branch --depth 1 https://github.com/kubernetes/kubernetes</span><br><span class="line">cd kubernetes</span><br><span class="line">KUBE_GIT_VERSION=v1.14.1 ./build/run.sh make kubelet GOFLAGS="-tags=nokmem"</span><br></pre></td></tr></table></figure>
<h4 id="这里采用升级内核的解决办法："><a href="#这里采用升级内核的解决办法：" class="headerlink" title="这里采用升级内核的解决办法："></a>这里采用升级内核的解决办法：</h4></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装完成后检查 /boot/grub2/grub.cfg 中对应内核 menuentry 中是否包含 initrd16 配置，如果没有，再安装一次！</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置开机从新内核启动</span></span><br><span class="line">grub2-set-default 0</span><br></pre></td></tr></table></figure>

<h4 id="重启机器："><a href="#重启机器：" class="headerlink" title="重启机器："></a>重启机器：</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sync</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>



<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li>系统内核相关参数参考：<a href="https://docs.openshift.com/enterprise/3.2/admin_guide/overcommit.html" target="_blank" rel="noopener">https://docs.openshift.com/enterprise/3.2/admin_guide/overcommit.html</a></li>
<li>3.10.x 内核 kmem bugs 相关的讨论和解决办法：<br>i. <a href="https://github.com/kubernetes/kubernetes/issues/61937" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/issues/61937</a><br>ii. <a href="https://support.mesosphere.com/s/article/Critical-Issue-KMEM-MSPH-2018-0006" target="_blank" rel="noopener">https://support.mesosphere.com/s/article/Critical-Issue-KMEM-MSPH-2018-0006</a><br>iii. <a href="https://pingcap.com/blog/try-to-fix-two-linux-kernel-bugs-while-testing-tidb-operator-in-k8s/" target="_blank" rel="noopener">https://pingcap.com/blog/try-to-fix-two-linux-kernel-bugs-while-testing-tidb-operator-in-k8s/</a></li>
</ul>
<h1 id="创建-CA-根证书和秘钥"><a href="#创建-CA-根证书和秘钥" class="headerlink" title="创建 CA 根证书和秘钥"></a>创建 CA 根证书和秘钥</h1><ul>
<li>为确保安全， kubernetes  系统各组件需要使用  x509  证书对通信进行加密和认证。</li>
<li>CA (Certificate Authority) 是自签名的根证书，用来签名后续创建的其它证书。</li>
<li>CA 证书是集群所有节点共享的，只需要创建一次，后续用它签名其它所有证书。</li>
<li>本文档使用  CloudFlare  的 PKI 工具集 cfssl 创建所有证书。</li>
<li>注意：如果没有特殊指明，本文档的所有操作均在 k8s-01 节点上执行。</li>
</ul>
<h2 id="安装-cfssl-工具集"><a href="#安装-cfssl-工具集" class="headerlink" title="安装 cfssl 工具集"></a>安装 cfssl 工具集</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/k8s/cert &amp;&amp; cd /opt/k8s/work</span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl_1.4.1_linux_amd64</span><br><span class="line">mv cfssl_1.4.1_linux_amd64 /opt/k8s/bin/cfssl</span><br><span class="line"></span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssljson_1.4.1_linux_amd64</span><br><span class="line">mv cfssljson_1.4.1_linux_amd64 /opt/k8s/bin/cfssljson</span><br><span class="line"></span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl-certinfo_1.4.1_linux_amd64</span><br><span class="line">mv cfssl-certinfo_1.4.1_linux_amd64 /opt/k8s/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line">chmod +x /opt/k8s/bin/*</span><br><span class="line">export PATH=/opt/k8s/bin:$PATH</span><br></pre></td></tr></table></figure>

<h2 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h2><p>CA 配置文件用于配置根证书的使用场景 (profile) 和具体参数 (usage，过期时间、服务端认证、客户端认证、加密等)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF &#123;</span><br><span class="line">	"signing": &#123;</span><br><span class="line">		"default": &#123;</span><br><span class="line">			"expiry": "87600h"</span><br><span class="line">		&#125;,</span><br><span class="line">		"profiles": &#123;</span><br><span class="line">			"kubernetes": &#123;</span><br><span class="line">				"usages": ["signing", "keyencipherment", "serverauth", "clientauth"],</span><br><span class="line">				"expiry": "876000h"</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>signing  ：表示该证书可用于签名其它证书（生成的  ca.pem  证书中CA=TRUE  ）；</li>
<li>server auth  ：表示 client 可以用该该证书对 server 提供的证书进行验证；</li>
<li>client auth  ：表示 server 可以用该该证书对 client 提供的证书进行验证；</li>
<li>“expiry”: “876000h”  ：证书有效期设置为 100 年；</li>
</ul>
<h2 id="创建证书签名请求文件"><a href="#创建证书签名请求文件" class="headerlink" title="创建证书签名请求文件"></a>创建证书签名请求文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF &#123;</span><br><span class="line">	"CN": "kubernetes-ca",</span><br><span class="line">	"key": &#123;</span><br><span class="line">		"algo": "rsa",</span><br><span class="line">		"size": 2048</span><br><span class="line">	&#125;,</span><br><span class="line">	"names": [&#123;</span><br><span class="line">		"C": "CN",</span><br><span class="line">		"ST": "BeiJing",</span><br><span class="line">		"L": "BeiJing",</span><br><span class="line">		"O": "k8s",</span><br><span class="line">		"OU": "opsnull"</span><br><span class="line">	&#125;],</span><br><span class="line">	"ca": &#123;</span><br><span class="line">		"expiry": "876000h"</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>CN：Common Name  ：kube-apiserver 从证书中提取该字段作为请求的用户名(User Name)，浏览器使用该字段验证网站是否合法；</li>
<li>O：Organization  ：kube-apiserver 从证书中提取该字段作为请求用户所属的组(Group)；</li>
<li>kube-apiserver 将提取的  User、Group  作为  RBAC  授权的用户标识；</li>
</ul>
<p>注意：</p>
<ol>
<li>不同证书 csr 文件的 CN、C、ST、L、O、OU 组合必须不同，否则可能出现PEER’S CERTIFICATE HAS AN INVALID SIGNATURE  错误；</li>
<li>后续创建证书的 csr 文件时，CN 都不相同（C、ST、L、O、OU 相同），以达到区分的目的；</li>
</ol>
<h2 id="生成-CA-证书和私钥"><a href="#生成-CA-证书和私钥" class="headerlink" title="生成 CA 证书和私钥"></a>生成 CA 证书和私钥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">ls ca*</span><br></pre></td></tr></table></figure>

<h2 id="分发证书文件"><a href="#分发证书文件" class="headerlink" title="分发证书文件"></a>分发证书文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "mkdir -p /etc/kubernetes/cert"</span><br><span class="line">scp ca*.pem ca-config.json root@$&#123;node_ip&#125;:/etc/kubernetes/cert</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="安装和配置-kubectl"><a href="#安装和配置-kubectl" class="headerlink" title="安装和配置 kubectl"></a>安装和配置 kubectl</h1><p>本文档介绍安装和配置 kubernetes 命令行管理工具 kubectl 的步骤。<br>注意：</p>
<ol>
<li>如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s-01 节点上执行；</li>
<li>本文档只需要部署一次，生成的 kubeconfig 文件是通用的，可以拷贝到需要执行kubectl 命令的机器的  ~/.kube/config  位置；</li>
</ol>
<h2 id="下载和分发-kubectl-二进制文件"><a href="#下载和分发-kubectl-二进制文件" class="headerlink" title="下载和分发 kubectl 二进制文件"></a>下载和分发 kubectl 二进制文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">wget https://dl.k8s.io/v1.16.6/kubernetes-client-linux-amd64.tar.gz #自行解决翻墙下载问题</span><br><span class="line">tar -xzvf kubernetes-client-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="分发到所有使用-kubectl-工具的节点："><a href="#分发到所有使用-kubectl-工具的节点：" class="headerlink" title="分发到所有使用 kubectl 工具的节点："></a>分发到所有使用 kubectl 工具的节点：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">scp kubernetes/client/bin/kubectl root@$&#123;node_ip&#125;:/opt/k8s/bin/</span><br><span class="line">ssh root@$&#123;node_ip&#125; "chmod +x /opt/k8s/bin/*"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="创建-admin-证书和私钥"><a href="#创建-admin-证书和私钥" class="headerlink" title="创建 admin 证书和私钥"></a>创建 admin 证书和私钥</h2><p>kubectl 使用 https 协议与 kube-apiserver 进行安全通信，kube-apiserver 对 kubectl 请求包含的证书进行认证和授权。<br>kubectl 后续用于集群管理，所以这里创建具有最高权限的 admin 证书。</p>
<h3 id="创建证书签名请求："><a href="#创建证书签名请求：" class="headerlink" title="创建证书签名请求："></a>创建证书签名请求：</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/<span class="keyword">work</span></span><br><span class="line">cat &gt; <span class="keyword">admin</span>-csr.json &lt;&lt; EOF &#123;</span><br><span class="line">	"CN": "admin",</span><br><span class="line">	"hosts": [],</span><br><span class="line">	"key": &#123;</span><br><span class="line">		"algo": "rsa",</span><br><span class="line">		"size": <span class="number">2048</span></span><br><span class="line">	&#125;,</span><br><span class="line">	"names": [&#123;</span><br><span class="line">		"C": "CN",</span><br><span class="line">		"ST": "BeiJing",</span><br><span class="line">		"L": "BeiJing",</span><br><span class="line">		"O": "system:masters",</span><br><span class="line">		"OU": "opsnull"</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>O: system:masters  ：kube-apiserver 收到使用该证书的客户端请求后，为请求添加组（Group）认证标识  system:masters  ；</li>
<li>预定义的 ClusterRoleBinding  cluster-admin  将 Group  system:masters  与Role  cluster-admin  绑定，该 Role 授予操作集群所需的最高权限；</li>
<li>该证书只会被 kubectl 当做 client 证书使用，所以  hosts  字段为空；</li>
</ul>
<h3 id="生成证书和私钥："><a href="#生成证书和私钥：" class="headerlink" title="生成证书和私钥："></a>生成证书和私钥：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">cfssl gencert -ca=/opt/k8s/work/ca.pem \</span><br><span class="line">-ca-key=/opt/k8s/work/ca-key.pem \</span><br><span class="line">-config=/opt/k8s/work/ca-config.json \</span><br><span class="line">-profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line">ls admin*</span><br></pre></td></tr></table></figure>

<ul>
<li>忽略警告消息  [WARNING] This certificate lacks a “hosts” field.  ；</li>
</ul>
<h2 id="创建-kubeconfig-文件"><a href="#创建-kubeconfig-文件" class="headerlink" title="创建 kubeconfig 文件"></a>创建 kubeconfig 文件</h2><p>kubectl 使用 kubeconfig 文件访问 apiserver，该文件包含 kube-apiserver 的地址和认证信息（CA 证书和客户端证书）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">--certificate-authority=/opt/k8s/work/ca.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--server=https://$&#123;NODE_IPS[0]&#125;:6443 \</span><br><span class="line">--kubeconfig=kubectl.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></span><br><span class="line">kubectl config set-credentials admin \</span><br><span class="line">--client-certificate=/opt/k8s/work/admin.pem \</span><br><span class="line">--client-key=/opt/k8s/work/admin-key.pem \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=kubectl.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></span><br><span class="line">kubectl config set-context kubernetes \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=admin \</span><br><span class="line">--kubeconfig=kubectl.kubeconfig</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置默认上下文</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=kubectl.kubeconfig</span><br></pre></td></tr></table></figure>

<ul>
<li>–certificate-authority  ：验证 kube-apiserver 证书的根证书；</li>
<li>–client-certificate  、 –client-key  ：刚生成的  admin  证书和私钥，与kube-apiserver https 通信时使用；</li>
<li>–embed-certs=true  ：将 ca.pem 和 admin.pem 证书内容嵌入到生成的kubectl.kubeconfig 文件中(否则，写入的是证书文件路径，后续拷贝 kubeconfig 到其它机器时，还需要单独拷贝证书文件，不方便。)；</li>
<li>–server  ：指定 kube-apiserver 的地址，这里指向第一个节点上的服务；</li>
</ul>
<h2 id="分发-kubeconfig-文件"><a href="#分发-kubeconfig-文件" class="headerlink" title="分发 kubeconfig 文件"></a>分发 kubeconfig 文件</h2><h3 id="分发到所有使用-kubectl-命令的节点："><a href="#分发到所有使用-kubectl-命令的节点：" class="headerlink" title="分发到所有使用  kubectl  命令的节点："></a>分发到所有使用  kubectl  命令的节点：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "mkdir -p ~/.kube"</span><br><span class="line">scp kubectl.kubeconfig root@$&#123;node_ip&#125;:~/.kube/config</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="部署-etcd-集群"><a href="#部署-etcd-集群" class="headerlink" title="部署 etcd 集群"></a>部署 etcd 集群</h1><p>etcd 是基于 Raft 的分布式 KV 存储系统，由 CoreOS 开发，常用于服务发现、共享配置以及并发控制（如 leader 选举、分布式锁等）。</p>
<p>kubernetes 使用 etcd 集群持久化存储所有 API 对象、运行数据。</p>
<p>本文档介绍部署一个三节点高可用 etcd 集群的步骤：</p>
<ul>
<li>下载和分发 etcd 二进制文件；</li>
<li>创建 etcd 集群各节点的 x509 证书，用于加密客户端(如 etcdctl) 与 etcd 集群、etcd 集群之间的通信；</li>
<li>创建 etcd 的 systemd unit 文件，配置服务参数；</li>
<li>检查集群工作状态；</li>
</ul>
<p>etcd 集群节点名称和 IP 如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k8s<span class="number">-01</span>：<span class="number">172.27</span><span class="number">.138</span><span class="number">.251</span></span><br><span class="line">k8s<span class="number">-02</span>：<span class="number">172.27</span><span class="number">.137</span><span class="number">.229</span></span><br><span class="line">k8s<span class="number">-03</span>：<span class="number">172.27</span><span class="number">.138</span><span class="number">.239</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ol>
<li>如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s-01 节点上执行；</li>
<li>flanneld 与本文档安装的 etcd v3.4.x 不兼容，如果要安装 flanneld（本文档使用calio），则需要将 etcd 降级到 v3.3.x 版本；</li>
</ol>
<h2 id="下载和分发-etcd-二进制文件"><a href="#下载和分发-etcd-二进制文件" class="headerlink" title="下载和分发 etcd 二进制文件"></a>下载和分发 etcd 二进制文件</h2><h3 id="到-etcd-的-release-页面-下载最新版本的发布包："><a href="#到-etcd-的-release-页面-下载最新版本的发布包：" class="headerlink" title="到 etcd 的 release 页面 下载最新版本的发布包："></a>到 etcd 的 release 页面 下载最新版本的发布包：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">wget https://github.com/coreos/etcd/releases/download/v3.4.3/etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class="line">tar -xvf etcd-v3.4.3-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="分发二进制文件到集群所有节点："><a href="#分发二进制文件到集群所有节点：" class="headerlink" title="分发二进制文件到集群所有节点："></a>分发二进制文件到集群所有节点：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">scp etcd-v3.4.3-linux-amd64/etcd* root@$&#123;node_ip&#125;:/opt/k8s/bin</span><br><span class="line">ssh root@$&#123;node_ip&#125; "chmod +x /opt/k8s/bin/*"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="创建-etcd-证书和私钥"><a href="#创建-etcd-证书和私钥" class="headerlink" title="创建 etcd 证书和私钥"></a>创建 etcd 证书和私钥</h2><h3 id="创建证书签名请求：-1"><a href="#创建证书签名请求：-1" class="headerlink" title="创建证书签名请求："></a>创建证书签名请求：</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt; EOF &#123;</span><br><span class="line">	"CN": "etcd",</span><br><span class="line">	"hosts": [</span><br><span class="line">		"127.0.0.1",</span><br><span class="line">		"172.27.138.251",</span><br><span class="line">		"172.27.137.229",</span><br><span class="line">		<span class="string">"172.27.138.239"</span></span><br><span class="line">	],</span><br><span class="line">	"key": &#123;</span><br><span class="line">		"algo": "rsa",</span><br><span class="line">		"size": 2048</span><br><span class="line">	&#125;,</span><br><span class="line">	"names": [&#123;</span><br><span class="line">		"C": "CN",</span><br><span class="line">		"ST": "BeiJing",</span><br><span class="line">		"L": "BeiJing",</span><br><span class="line">		"O": "k8s",</span><br><span class="line">		"OU": "opsnull"</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>hosts  ：指定授权使用该证书的 etcd 节点 IP 列表，需要将 etcd 集群所有节点 IP都列在其中；</li>
</ul>
<h3 id="生成证书和私钥：-1"><a href="#生成证书和私钥：-1" class="headerlink" title="生成证书和私钥："></a>生成证书和私钥：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">cfssl gencert -ca=/opt/k8s/work/ca.pem \</span><br><span class="line">-ca-key=/opt/k8s/work/ca-key.pem \</span><br><span class="line">-config=/opt/k8s/work/ca-config.json \</span><br><span class="line">-profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line">ls etcd*pem</span><br></pre></td></tr></table></figure>

<h3 id="分发生成的证书和私钥到各-etcd-节点："><a href="#分发生成的证书和私钥到各-etcd-节点：" class="headerlink" title="分发生成的证书和私钥到各 etcd 节点："></a>分发生成的证书和私钥到各 etcd 节点：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "mkdir -p /etc/etcd/cert"</span><br><span class="line">scp etcd*.pem root@$&#123;node_ip&#125;:/etc/etcd/cert/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="创建-etcd-的-systemd-unit-模板文件"><a href="#创建-etcd-的-systemd-unit-模板文件" class="headerlink" title="创建 etcd 的 systemd unit 模板文件"></a>创建 etcd 的 systemd unit 模板文件</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; etcd.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Etcd Server</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"><span class="attribute">Wants</span>=network-online.target</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/coreos</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">WorkingDirectory</span>=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span></span><br><span class="line"><span class="attribute">ExecStart</span>=/opt/k8s/bin/etcd \\</span><br><span class="line"><span class="attribute">--data-dir</span>=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span> \\</span><br><span class="line"><span class="attribute">--wal-dir</span>=<span class="variable">$&#123;ETCD_WAL_DIR&#125;</span> \\</span><br><span class="line"><span class="attribute">--name</span>=##NODE_NAME## \\</span><br><span class="line"><span class="attribute">--cert-file</span>=/etc/etcd/cert/etcd.pem \\</span><br><span class="line"><span class="attribute">--key-file</span>=/etc/etcd/cert/etcd-key.pem \\</span><br><span class="line"><span class="attribute">--trusted-ca-file</span>=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line"><span class="attribute">--peer-cert-file</span>=/etc/etcd/cert/etcd.pem \\</span><br><span class="line"><span class="attribute">--peer-key-file</span>=/etc/etcd/cert/etcd-key.pem \\</span><br><span class="line"><span class="attribute">--peer-trusted-ca-file</span>=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">--peer-client-cert-auth \\</span><br><span class="line">--client-cert-auth \\</span><br><span class="line"><span class="attribute">--listen-peer-urls</span>=https://##NODE_IP##:2380 \\</span><br><span class="line"><span class="attribute">--initial-advertise-peer-urls</span>=https://##NODE_IP##:2380 \\</span><br><span class="line"><span class="attribute">--listen-client-urls</span>=https://##NODE_IP##:2379,http://127.0.0.1:2379 \\</span><br><span class="line"><span class="attribute">--advertise-client-urls</span>=https://##NODE_IP##:2379 \\</span><br><span class="line"><span class="attribute">--initial-cluster-token</span>=etcd-cluster-0 \\</span><br><span class="line"><span class="attribute">--initial-cluster</span>=<span class="variable">$&#123;ETCD_NODES&#125;</span> \\</span><br><span class="line"><span class="attribute">--initial-cluster-state</span>=new \\</span><br><span class="line"><span class="attribute">--auto-compaction-mode</span>=periodic \\</span><br><span class="line"><span class="attribute">--auto-compaction-retention</span>=1 \\</span><br><span class="line"><span class="attribute">--max-request-bytes</span>=33554432 \\</span><br><span class="line"><span class="attribute">--quota-backend-bytes</span>=6442450944 \\</span><br><span class="line"><span class="attribute">--heartbeat-interval</span>=250 \\</span><br><span class="line"><span class="attribute">--election-timeout</span>=2000</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>WorkingDirectory  、 –data-dir  ：指定工作目录和数据目录为${ETCD_DATA_DIR}  ，需在启动服务前创建这个目录；</li>
<li>–wal-dir  ：指定 wal 目录，为了提高性能，一般使用 SSD 或者和  –data-dir  不同的磁盘；</li>
<li>–name  ：指定节点名称，当  –initial-cluster-state  值为  new  时， –name  的参数值必须位于  –initial-cluster  列表中；</li>
<li>–cert-file  、 –key-file  ：etcd server 与 client 通信时使用的证书和私钥；</li>
<li>–trusted-ca-file  ：签名 client 证书的 CA 证书，用于验证 client 证书；</li>
<li>–peer-cert-file  、 –peer-key-file  ：etcd 与 peer 通信使用的证书和私钥；</li>
<li>–peer-trusted-ca-file  ：签名 peer 证书的 CA 证书，用于验证 peer 证书；</li>
</ul>
<h3 id="为各节点创建和分发-etcd-systemd-unit-文件"><a href="#为各节点创建和分发-etcd-systemd-unit-文件" class="headerlink" title="为各节点创建和分发 etcd systemd unit 文件"></a>为各节点创建和分发 etcd systemd unit 文件</h3><p>替换模板文件中的变量，为各节点创建 systemd unit 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for (( i=0; i &lt; 3; i++ ))</span><br><span class="line">do</span><br><span class="line">sed -e "s/##NODE_NAME##/$&#123;NODE_NAMES[i]&#125;/" -e "s/##NODE_IP##/$&#123;NO</span><br><span class="line">DE_IPS[i]&#125;/" etcd.service.template &gt; etcd-$&#123;NODE_IPS[i]&#125;.service</span><br><span class="line">done</span><br><span class="line">ls *.service</span><br></pre></td></tr></table></figure>

<ul>
<li>NODE_NAMES 和 NODE_IPS 为相同长度的 bash 数组，分别为节点名称和对应的 IP；</li>
</ul>
<p>分发生成的 systemd unit 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">scp etcd-$&#123;node_ip&#125;.service root@$&#123;node_ip&#125;:/etc/systemd/system/e</span><br><span class="line">tcd.service</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="启动-etcd-服务"><a href="#启动-etcd-服务" class="headerlink" title="启动 etcd 服务"></a>启动 etcd 服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "mkdir -p $&#123;ETCD_DATA_DIR&#125; $&#123;ETCD_WAL_DIR&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "systemctl daemon-reload &amp;&amp; systemctl enable</span><br><span class="line">etcd &amp;&amp; systemctl restart etcd " &amp;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ul>
<li>必须先创建 etcd 数据目录和工作目录;</li>
<li>etcd 进程首次启动时会等待其它节点的 etcd 加入集群，命令  systemctl startetcd  会卡住一段时间，为正常现象；</li>
</ul>
<h3 id="检查启动结果"><a href="#检查启动结果" class="headerlink" title="检查启动结果"></a>检查启动结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "systemctl status etcd|grep Active"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>确保状态为  active (running)  ，否则查看日志，确认原因：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">journalctl -u etcd</span></span><br></pre></td></tr></table></figure>

<h3 id="验证服务状态"><a href="#验证服务状态" class="headerlink" title="验证服务状态"></a>验证服务状态</h3><p>部署完 etcd 集群后，在任一 etcd 节点上执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">/opt/k8s/bin/etcdctl \</span><br><span class="line">--endpoints=https://$&#123;node_ip&#125;:2379 \</span><br><span class="line">--cacert=/etc/kubernetes/cert/ca.pem \</span><br><span class="line">--cert=/etc/etcd/cert/etcd.pem \</span><br><span class="line">--key=/etc/etcd/cert/etcd-key.pem endpoint health</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ul>
<li>3.4.3 版本的 etcd/etcdctl 默认启用了 V3 API，所以执行 etcdctl 命令时不需要再指定环境变量  ETCDCTL_API=3  ；</li>
<li>从 K8S 1.13 开始，不再支持 v2 版本的 etcd；</li>
</ul>
<p>预期输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; 172.27.138.251</span></span><br><span class="line">https://172.27.138.251:2379 is healthy: successfully committed proposal: took = 2.756451ms</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; 172.27.137.229</span></span><br><span class="line">https://172.27.137.229:2379 is healthy: successfully committed proposal: took = 2.025018ms</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; 172.27.138.239</span></span><br><span class="line">https://172.27.138.239:2379 is healthy: successfully committed proposal: took = 2.335097ms</span><br></pre></td></tr></table></figure>

<p>输出均为  healthy  时表示集群服务正常。</p>
<h3 id="查看当前的-leader"><a href="#查看当前的-leader" class="headerlink" title="查看当前的 leader"></a>查看当前的 leader</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">/opt/k8s/bin/etcdctl \</span><br><span class="line">-w table --cacert=/etc/kubernetes/cert/ca.pem \</span><br><span class="line">--cert=/etc/etcd/cert/etcd.pem \</span><br><span class="line">--key=/etc/etcd/cert/etcd-key.pem \</span><br><span class="line">--endpoints=$&#123;ETCD_ENDPOINTS&#125; endpoint status</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+-----------------------------+</span>------------------<span class="code">+---------+</span>---------</span><br><span class="line"><span class="code">+-----------+</span>------------<span class="code">+-----------+</span>------------+------------------</span><br><span class="line">--<span class="code">+--------+</span></span><br><span class="line">| ENDPOINT | ID | VERSION | DB SIZE |</span><br><span class="line">IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX</span><br><span class="line">| ERRORS |</span><br><span class="line"><span class="code">+-----------------------------+</span>------------------<span class="code">+---------+</span>---------</span><br><span class="line"><span class="code">+-----------+</span>------------<span class="code">+-----------+</span>------------+------------------</span><br><span class="line">--<span class="code">+--------+</span></span><br><span class="line">| https://172.27.138.251:2379 | 4250b255e93e0076 | 3.4.3 | 20 kB |</span><br><span class="line">false | false | 2 | 8 | 8</span><br><span class="line">| |</span><br><span class="line">| https://172.27.137.229:2379 | b3d912e6166f1213 | 3.4.3 | 20 kB |</span><br><span class="line">true | false | 2 | 8 | 8</span><br><span class="line">| |</span><br><span class="line">| https://172.27.138.239:2379 | 8a4d4a2904de8446 | 3.4.3 | 20 kB |</span><br><span class="line">false | false | 2 | 8 | 8</span><br><span class="line">| |</span><br><span class="line"><span class="code">+-----------------------------+</span>------------------<span class="code">+---------+</span>---------</span><br><span class="line"><span class="code">+-----------+</span>------------<span class="code">+-----------+</span>------------+------------------</span><br><span class="line">--<span class="code">+--------+</span></span><br></pre></td></tr></table></figure>

<ul>
<li>可见，当前的 leader 为 172.27.138.229。</li>
</ul>
<h1 id="部署-master-节点"><a href="#部署-master-节点" class="headerlink" title="部署 master 节点"></a>部署 master 节点</h1><p>kubernetes master 节点运行如下组件：</p>
<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
</ul>
<p>kube-apiserver、kube-scheduler 和 kube-controller-manager 均以多实例模式运行：</p>
<ol>
<li>kube-scheduler 和 kube-controller-manager 会自动选举产生一个 leader 实例，其它实例处于阻塞模式，当 leader 挂了后，重新选举产生新的 leader，从而保证服务可用性；</li>
<li>kube-apiserver 是无状态的，可以通过 kube-nginx 进行代理访问（见06-2.apiserver高可用），从而保证服务可用性；<br>注意：如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s01 节点9上执行。</li>
</ol>
<h2 id="下载最新版本二进制文件"><a href="#下载最新版本二进制文件" class="headerlink" title="下载最新版本二进制文件"></a>下载最新版本二进制文件</h2><h3 id="下载二进制-tar-文件并解压："><a href="#下载二进制-tar-文件并解压：" class="headerlink" title="下载二进制 tar 文件并解压："></a>下载二进制 tar 文件并解压：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">wget https://dl.k8s.io/v1.16.6/kubernetes-server-linux-amd64.tar.gz# 自行解决翻墙问题</span><br><span class="line">tar -xzvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes</span><br><span class="line">tar -xzvf kubernetes-src.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="将二进制文件拷贝到所有-master-节点："><a href="#将二进制文件拷贝到所有-master-节点：" class="headerlink" title="将二进制文件拷贝到所有 master 节点："></a>将二进制文件拷贝到所有 master 节点：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">scp kubernetes/server/bin/&#123;apiextensions-apiserver,kube-apiserver</span><br><span class="line">,kube-controller-manager,kube-proxy,kube-scheduler,kubeadm,kubectl,ku</span><br><span class="line">belet,mounter&#125; root@$&#123;node_ip&#125;:/opt/k8s/bin/</span><br><span class="line">ssh root@$&#123;node_ip&#125; "chmod +x /opt/k8s/bin/*"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="部署-kube-apiserver-集群"><a href="#部署-kube-apiserver-集群" class="headerlink" title="部署 kube-apiserver 集群"></a>部署 kube-apiserver 集群</h2><p>本文档讲解部署一个三实例 kube-apiserver 集群的步骤.<br>注意：如果没有特殊指明，本文档的所有操作均在 k8s-01 节点上执行。</p>
<h3 id="创建-kubernetes-master-证书和私钥"><a href="#创建-kubernetes-master-证书和私钥" class="headerlink" title="创建 kubernetes-master 证书和私钥"></a>创建 kubernetes-master 证书和私钥</h3><h4 id="创建证书签名请求：-2"><a href="#创建证书签名请求：-2" class="headerlink" title="创建证书签名请求："></a>创建证书签名请求：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kubernetes-csr.json &lt;&lt; EOF &#123;</span><br><span class="line">	"CN": "kubernetes-master",</span><br><span class="line">	"hosts": [</span><br><span class="line">		"127.0.0.1",</span><br><span class="line">		"172.27.138.251",</span><br><span class="line">		"172.27.137.229",</span><br><span class="line">		"172.27.138.239",</span><br><span class="line">		"$&#123;CLUSTER_KUBERNETES_SVC_IP&#125;",</span><br><span class="line">		"kubernetes",</span><br><span class="line">		"kubernetes.default",</span><br><span class="line">		"kubernetes.default.svc",</span><br><span class="line">		"kubernetes.default.svc.cluster",</span><br><span class="line">		"kubernetes.default.svc.cluster.local.",</span><br><span class="line">		<span class="string">"kubernetes.default.svc.$&#123;CLUSTER_DNS_DOMAIN&#125;."</span></span><br><span class="line">	],</span><br><span class="line">	"key": &#123;</span><br><span class="line">		"algo": "rsa",</span><br><span class="line">		"size": 2048</span><br><span class="line">	&#125;,</span><br><span class="line">	"names": [&#123;</span><br><span class="line">		"C": "CN",</span><br><span class="line">		"ST": "BeiJing",</span><br><span class="line">		"L": "BeiJing",</span><br><span class="line">		"O": "k8s",</span><br><span class="line">		"OU": "opsnull"</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>hosts 字段指定授权使用该证书的 IP 和域名列表，这里列出了 master 节点 IP、kubernetes 服务的 IP 和域名；</li>
</ul>
<p>生成证书和私钥：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=/opt/k8s/work/ca.pem \</span><br><span class="line">-ca-key=/opt/k8s/work/ca-key.pem \</span><br><span class="line">-config=/opt/k8s/work/ca-config.json \</span><br><span class="line">-profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernete</span><br><span class="line">s</span><br><span class="line">ls kubernetes*pem</span><br></pre></td></tr></table></figure>

<p>将生成的证书和私钥文件拷贝到所有 master 节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "mkdir -p /etc/kubernetes/cert"</span><br><span class="line">scp kubernetes*.pem root@$&#123;node_ip&#125;:/etc/kubernetes/cert/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="创建加密配置文件"><a href="#创建加密配置文件" class="headerlink" title="创建加密配置文件"></a>创建加密配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/work</span></span><br><span class="line"><span class="string">source</span> <span class="string">/opt/k8s/bin/environment.sh</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">encryption-config.yaml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EncryptionConfig</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="attr">providers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">aescbc:</span></span><br><span class="line">        <span class="attr">keys:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">key1</span></span><br><span class="line">            <span class="attr">secret:</span> <span class="string">$&#123;ENCRYPTION_KEY&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">identity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="将加密配置文件拷贝到-master-节点的-etc-kubernetes-目录下："><a href="#将加密配置文件拷贝到-master-节点的-etc-kubernetes-目录下：" class="headerlink" title="将加密配置文件拷贝到 master 节点的  /etc/kubernetes  目录下："></a>将加密配置文件拷贝到 master 节点的  /etc/kubernetes  目录下：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">scp encryption-config.yaml root@$&#123;node_ip&#125;:/etc/kubernetes/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="创建审计策略文件"><a href="#创建审计策略文件" class="headerlink" title="创建审计策略文件"></a>创建审计策略文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/work</span></span><br><span class="line"><span class="string">source</span> <span class="string">/opt/k8s/bin/environment.sh</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">audit-policy.yaml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># The following requests were manually identified as high-volume and low-risk, so drop them.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">services/status</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:kube-proxy'</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">    <span class="attr">userGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:nodes'</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">namespaces:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kube-system</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:kube-scheduler'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:serviceaccount:kube-system:endpoint-controller'</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">namespaces/status</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">namespaces/finalize</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:apiserver'</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log HPA fetching metrics.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:kube-controller-manager'</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log these read-only URLs.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">nonResourceURLs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'/healthz*'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/version</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'/swagger*'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Don't log events requests.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">  <span class="comment"># node and pod status calls from nodes are high-volume and can be large, don't log responses</span></span><br><span class="line">  <span class="comment"># for expected updates from nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RequestReceived</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">pods/status</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kubelet</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:node-problem-detector'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:serviceaccount:kube-system:node-problem-detector'</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RequestReceived</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">pods/status</span></span><br><span class="line">    <span class="attr">userGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:nodes'</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># deletecollection calls can be large, don't log responses for expected namespace deletions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RequestReceived</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'system:serviceaccount:kube-system:namespace-controller'</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">deletecollection</span></span><br><span class="line">  <span class="comment"># Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span></span><br><span class="line">  <span class="comment"># so only log at the Metadata level.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">  <span class="attr">omitStages:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RequestReceived</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">authentication.k8s.io</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">tokenreviews</span></span><br><span class="line">  <span class="comment"># Get repsonses can be large; skip them.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RequestReceived</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">admissionregistration.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">apiextensions.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">apiregistration.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">apps</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">authentication.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">authorization.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">autoscaling</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">batch</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">certificates.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">extensions</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">networking.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">policy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">scheduling.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">settings.k8s.io</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">storage.k8s.io</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Default level for known APIs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">RequestResponse</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RequestReceived</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">""</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">admissionregistration.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">apiextensions.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">apiregistration.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">apps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">authentication.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">authorization.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">autoscaling</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">batch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">certificates.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">networking.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">policy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">scheduling.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">settings.k8s.io</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">storage.k8s.io</span></span><br><span class="line">  <span class="comment"># Default level for all other requests.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Metadata</span></span><br><span class="line">    <span class="attr">omitStages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RequestReceived</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="分发审计策略文件："><a href="#分发审计策略文件：" class="headerlink" title="分发审计策略文件："></a>分发审计策略文件：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">scp audit-policy.yaml root@$&#123;node_ip&#125;:/etc/kubernetes/audit-policy.yaml</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="创建后续访问-metrics-server-或-kube-prometheus使用的证书"><a href="#创建后续访问-metrics-server-或-kube-prometheus使用的证书" class="headerlink" title="创建后续访问 metrics-server 或 kube-prometheus使用的证书"></a>创建后续访问 metrics-server 或 kube-prometheus使用的证书</h3><h4 id="创建证书签名请求"><a href="#创建证书签名请求" class="headerlink" title="创建证书签名请求:"></a>创建证书签名请求:</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">opt</span>/k8s/work</span><br><span class="line"><span class="keyword">cat</span> &gt; proxy-client-csr.json &lt;&lt; EOF &#123;</span><br><span class="line">	<span class="string">"CN"</span>: <span class="string">"aggregator"</span>,</span><br><span class="line">	<span class="string">"hosts"</span>: [],</span><br><span class="line">	<span class="string">"key"</span>: &#123;</span><br><span class="line">		<span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">		<span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"names"</span>: [&#123;</span><br><span class="line">		<span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">		<span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">		<span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">		<span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">		<span class="string">"OU"</span>: <span class="string">"opsnull"</span></span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>CN 名称需要位于 kube-apiserver 的  –requestheader-allowed-names  参数中，否则后续访问 metrics 时会提示权限不足。</li>
</ul>
<h4 id="生成证书和私钥：-2"><a href="#生成证书和私钥：-2" class="headerlink" title="生成证书和私钥："></a>生成证书和私钥：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=/etc/kubernetes/cert/ca.pem \</span><br><span class="line">-ca-key=/etc/kubernetes/cert/ca-key.pem \</span><br><span class="line">-config=/etc/kubernetes/cert/ca-config.json \</span><br><span class="line">-profile=kubernetes proxy-client-csr.json | cfssljson -bare proxy-client</span><br><span class="line">ls proxy-client*.pem</span><br></pre></td></tr></table></figure>

<h4 id="将生成的证书和私钥文件拷贝到所有-master-节点："><a href="#将生成的证书和私钥文件拷贝到所有-master-节点：" class="headerlink" title="将生成的证书和私钥文件拷贝到所有 master 节点："></a>将生成的证书和私钥文件拷贝到所有 master 节点：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">scp proxy-client*.pem root@$&#123;node_ip&#125;:/etc/kubernetes/cert/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="创建-kube-apiserver-systemd-unit-模板文件"><a href="#创建-kube-apiserver-systemd-unit-模板文件" class="headerlink" title="创建 kube-apiserver systemd unit 模板文件"></a>创建 kube-apiserver systemd unit 模板文件</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kube-apiserver.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes API Server</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">WorkingDirectory</span>=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-apiserver</span><br><span class="line"><span class="attribute">ExecStart</span>=/opt/k8s/bin/kube-apiserver \\</span><br><span class="line">  <span class="attribute">--advertise-address</span>=##NODE_IP## \\</span><br><span class="line">  <span class="attribute">--default-not-ready-toleration-seconds</span>=360 \\</span><br><span class="line">  <span class="attribute">--default-unreachable-toleration-seconds</span>=360 \\</span><br><span class="line">  <span class="attribute">--feature-gates</span>=DynamicAuditing=true \\</span><br><span class="line">  <span class="attribute">--max-mutating-requests-inflight</span>=2000 \\</span><br><span class="line">  <span class="attribute">--max-requests-inflight</span>=4000 \\</span><br><span class="line">  <span class="attribute">--default-watch-cache-size</span>=200 \\</span><br><span class="line">  <span class="attribute">--delete-collection-workers</span>=2 \\</span><br><span class="line">  <span class="attribute">--encryption-provider-config</span>=/etc/kubernetes/encryption-config.yaml\\</span><br><span class="line">  <span class="attribute">--etcd-cafile</span>=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  <span class="attribute">--etcd-certfile</span>=/etc/kubernetes/cert/kubernetes.pem \\</span><br><span class="line">  <span class="attribute">--etcd-keyfile</span>=/etc/kubernetes/cert/kubernetes-key.pem \\</span><br><span class="line">  <span class="attribute">--etcd-servers</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \\</span><br><span class="line">  <span class="attribute">--bind-address</span>=##NODE_IP## \\</span><br><span class="line">  <span class="attribute">--secure-port</span>=6443 \\</span><br><span class="line">  <span class="attribute">--tls-cert-file</span>=/etc/kubernetes/cert/kubernetes.pem \\</span><br><span class="line">  <span class="attribute">--tls-private-key-file</span>=/etc/kubernetes/cert/kubernetes-key.pem \\</span><br><span class="line">  <span class="attribute">--insecure-port</span>=0 \\</span><br><span class="line">  --audit-dynamic-configuration \\</span><br><span class="line">  <span class="attribute">--audit-log-maxage</span>=15 \\</span><br><span class="line">  <span class="attribute">--audit-log-maxbackup</span>=3 \\</span><br><span class="line">  <span class="attribute">--audit-log-maxsize</span>=100 \\</span><br><span class="line">  --audit-log-truncate-enabled \\</span><br><span class="line">  <span class="attribute">--audit-log-path</span>=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-apiserver/audit.log \\</span><br><span class="line">  <span class="attribute">--audit-policy-file</span>=/etc/kubernetes/audit-policy.yaml \\</span><br><span class="line">  --profiling \\</span><br><span class="line">  <span class="attribute">--anonymous-auth</span>=<span class="literal">false</span> \\</span><br><span class="line">  <span class="attribute">--client-ca-file</span>=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --enable-bootstrap-token-auth \\</span><br><span class="line">  <span class="attribute">--requestheader-allowed-names</span>=<span class="string">"aggregator"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-client-ca-file</span>=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  <span class="attribute">--requestheader-extra-headers-prefix</span>=<span class="string">"X-Remote-Extra-"</span> \\</span><br><span class="line">  <span class="attribute">--requestheader-group-headers</span>=X-Remote-Group \\</span><br><span class="line">  <span class="attribute">--requestheader-username-headers</span>=X-Remote-User \\</span><br><span class="line">  <span class="attribute">--service-account-key-file</span>=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  <span class="attribute">--authorization-mode</span>=Node,RBAC \\</span><br><span class="line">  <span class="attribute">--runtime-config</span>=api/all=true \\</span><br><span class="line">  <span class="attribute">--enable-admission-plugins</span>=NodeRestriction \\</span><br><span class="line">  <span class="attribute">--allow-privileged</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--apiserver-count</span>=3 \\</span><br><span class="line">  <span class="attribute">--event-ttl</span>=168h \\</span><br><span class="line">  <span class="attribute">--kubelet-certificate-authority</span>=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  <span class="attribute">--kubelet-client-certificate</span>=/etc/kubernetes/cert/kubernetes.pem \\</span><br><span class="line">  <span class="attribute">--kubelet-client-key</span>=/etc/kubernetes/cert/kubernetes-key.pem \\</span><br><span class="line">  <span class="attribute">--kubelet-https</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--kubelet-timeout</span>=10s \\</span><br><span class="line">  <span class="attribute">--proxy-client-cert-file</span>=/etc/kubernetes/cert/proxy-client.pem \\</span><br><span class="line">  <span class="attribute">--proxy-client-key-file</span>=/etc/kubernetes/cert/proxy-client-key.pem \\</span><br><span class="line">  <span class="attribute">--service-cluster-ip-range</span>=<span class="variable">$&#123;SERVICE_CIDR&#125;</span> \\</span><br><span class="line">  <span class="attribute">--service-node-port-range</span>=<span class="variable">$&#123;NODE_PORT_RANGE&#125;</span> \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=10</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li><p>–advertise-address  ：apiserver 对外通告的 IP（kubernetes 服务后端节点IP）；</p>
</li>
<li><p>–default-*-toleration-seconds  ：设置节点异常相关的阈值；<br>*</p>
</li>
<li><p><em>–max-</em>-requests-inflight  ：请求相关的最大阈值；</p>
</li>
<li><p>–etcd-*  ：访问 etcd 的证书和 etcd 服务器地址；</p>
</li>
<li><p>–bind-address  ： https 监听的 IP，不能为  127.0.0.1  ，否则外界不能访问它的安全端口 6443；</p>
</li>
<li><p>–secret-port  ：https 监听端口；</p>
</li>
<li><p>–insecure-port=0  ：关闭监听 http 非安全端口(8080)；</p>
</li>
<li><p>–tls-*-file  ：指定 apiserver 使用的证书、私钥和 CA 文件；</p>
</li>
<li><p>–audit-*  ：配置审计策略和审计日志文件相关的参数；</p>
</li>
<li><p>–client-ca-file  ：验证 client (kue-controller-manager、kube-scheduler、kubelet、kube-proxy 等)请求所带的证书；</p>
</li>
<li><p>–enable-bootstrap-token-auth  ：启用 kubelet bootstrap 的 token 认证；</p>
</li>
<li><p>–requestheader-*  ：kube-apiserver 的 aggregator layer 相关的配置参数，proxy-client &amp; HPA 需要使用；</p>
</li>
<li><p>–requestheader-client-ca-file  ：用于签名  –proxy-client-cert-file和  –proxy-client-key-file  指定的证书；在启用了 metric aggregator 时使用；</p>
</li>
<li><p>–requestheader-allowed-names  ：不能为空，值为逗号分割的  –proxy-client-cert-file  证书的 CN 名称，这里设置为 “aggregator”；</p>
</li>
<li><p>–service-account-key-file  ：签名 ServiceAccount Token 的公钥文件，kube-controller-manager 的  –service-account-private-key-file  指定私钥文件，两者配对使用；</p>
</li>
<li><p>–runtime-config=api/all=true  ： 启用所有版本的 APIs，如autoscaling/v2alpha1；</p>
</li>
<li><p>–authorization-mode=Node,RBAC  、 –anonymous-auth=false  ： 开启Node 和 RBAC 授权模式，拒绝未授权的请求；</p>
</li>
<li><p>–enable-admission-plugins  ：启用一些默认关闭的 plugins；</p>
</li>
<li><p>–allow-privileged  ：运行执行 privileged 权限的容器；</p>
</li>
<li><p>–apiserver-count=3  ：指定 apiserver 实例的数量；</p>
</li>
<li><p>–event-ttl  ：指定 events 的保存时间；</p>
</li>
<li><p>–kubelet-*  ：如果指定，则使用 https 访问 kubelet APIs；需要为证书对应的用户(上面 kubernetes*.pem 证书的用户为 kubernetes) 用户定义 RBAC 规则，否则访问 kubelet API 时提示未授权；<br>*</p>
</li>
<li><p><em>–proxy-client-</em>  ：apiserver 访问 metrics-server 使用的证书；</p>
</li>
<li><p>–service-cluster-ip-range  ： 指定 Service Cluster IP 地址段；</p>
</li>
<li><p>–service-node-port-range  ： 指定 NodePort 的端口范围；</p>
</li>
</ul>
<p>如果 kube-apiserver 机器没有运行 kube-proxy，则还需要添加  –enable-aggregator-routing=true  参数；<br>关于  –requestheader-XXX  相关参数，参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/apiserver-builder/blob/master/docs/concepts/auth.md" target="_blank" rel="noopener">https://github.com/kubernetes-incubator/apiserver-builder/blob/master/docs/concepts/auth.md</a></li>
<li><a href="https://docs.bitnami.com/kubernetes/how-to/configure-autoscaling-custom-metrics/" target="_blank" rel="noopener">https://docs.bitnami.com/kubernetes/how-to/configure-autoscaling-custom-metrics/</a></li>
</ul>
<p>注意：</p>
<ol>
<li>–requestheader-client-ca-file  指定的 CA 证书，必须具有  client authand server auth  ；</li>
<li>如果  –requestheader-allowed-names  不为空,且  –proxy-client-cert-file  证书的 CN 名称不在 allowed-names 中，则后续查看 node 或 pods 的metrics 失败，提示：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl top nodes</span></span><br><span class="line">Error from server (Forbidden): nodes.metrics.k8s.io is forbidden:User "aggregator" cannot list resource "nodes" in API group "metrics.k8s.io" at the cluster scope</span><br></pre></td></tr></table></figure>

<h3 id="为各节点创建和分发-kube-apiserver-systemd-unit文件"><a href="#为各节点创建和分发-kube-apiserver-systemd-unit文件" class="headerlink" title="为各节点创建和分发 kube-apiserver systemd unit文件"></a>为各节点创建和分发 kube-apiserver systemd unit文件</h3><h4 id="替换模板文件中的变量，为各节点生成-systemd-unit-文件："><a href="#替换模板文件中的变量，为各节点生成-systemd-unit-文件：" class="headerlink" title="替换模板文件中的变量，为各节点生成 systemd unit 文件："></a>替换模板文件中的变量，为各节点生成 systemd unit 文件：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for (( i=0; i &lt; 3; i++ ))</span><br><span class="line">do</span><br><span class="line">sed -e "s/##NODE_NAME##/$&#123;NODE_NAMES[i]&#125;/" -e "s/##NODE_IP##/$&#123;NODE_IPS[i]&#125;/" kube-apiserver.service.template &gt; kube-apiserver-$&#123;NODE_IPS[i]&#125;.service</span><br><span class="line">done</span><br><span class="line">ls kube-apiserver*.service</span><br></pre></td></tr></table></figure>

<ul>
<li>NODE_NAMES 和 NODE_IPS 为相同长度的 bash 数组，分别为节点名称和对应的 IP；</li>
</ul>
<h4 id="分发生成的-systemd-unit-文件："><a href="#分发生成的-systemd-unit-文件：" class="headerlink" title="分发生成的 systemd unit 文件："></a>分发生成的 systemd unit 文件：</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;</span>NODE_IPS[@]&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">echo <span class="string">"&gt;&gt;&gt; $&#123;node_ip&#125;"</span></span><br><span class="line">scp kube-apiserver-<span class="variable">$&#123;</span>node_ip&#125;.service root@<span class="variable">$&#123;</span>node_ip&#125;<span class="symbol">:/etc/systemd/system/kube-apiserver</span>.service</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>启动 kube-apiserver 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "mkdir -p $&#123;K8S_DIR&#125;/kube-apiserver"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="检查-kube-apiserver-运行状态"><a href="#检查-kube-apiserver-运行状态" class="headerlink" title="检查 kube-apiserver 运行状态"></a>检查 kube-apiserver 运行状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "&gt;&gt;&gt; $&#123;node_ip&#125;"</span><br><span class="line">ssh root@$&#123;node_ip&#125; "systemctl status kube-apiserver |grep 'Active:'"</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>确保状态为  active (running)  ，否则查看日志，确认原因：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">journalctl -u kube-apiserver</span></span><br></pre></td></tr></table></figure>

<h3 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl cluster-info</span></span><br><span class="line">Kubernetes master is running at https://172.27.138.251:6443</span><br><span class="line">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get all --all-namespaces</span></span><br><span class="line">NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span><br><span class="line">default service/kubernetes ClusterIP 10.254.0.1 &lt;none&gt; 443/TCP 3m53s</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get componentstatuses</span></span><br><span class="line">NAME AGE</span><br><span class="line">controller-manager &lt;unknown&gt;</span><br><span class="line">scheduler &lt;unknown&gt;</span><br><span class="line">etcd-0 &lt;unknown&gt;</span><br><span class="line">etcd-2 &lt;unknown&gt;</span><br><span class="line">etcd-1 &lt;unknown&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>Kubernetes 1.16.6 存在 Bugs 导致返回结果一直为  <unknown>  ，但  kubectlget cs -o yaml  可以返回正确结果；</unknown></li>
</ul>
<h3 id="检查-kube-apiserver-监听的端口"><a href="#检查-kube-apiserver-监听的端口" class="headerlink" title="检查 kube-apiserver 监听的端口"></a>检查 kube-apiserver 监听的端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo netstat -lnpt|grep kube</span></span><br><span class="line">tcp 0 0 172.27.138.251:6443 0.0.0.0:* LISTEN 101442/kube-apiserv</span><br></pre></td></tr></table></figure>

<ul>
<li>6443: 接收 https 请求的安全端口，对所有请求做认证和授权；</li>
<li>由于关闭了非安全端口，故没有监听 8080；</li>
</ul>
<h2 id="部署高可用-kube-controller-manager-集群"><a href="#部署高可用-kube-controller-manager-集群" class="headerlink" title="部署高可用 kube-controller-manager 集群"></a>部署高可用 kube-controller-manager 集群</h2><p>本文档介绍部署高可用 kube-controller-manager 集群的步骤。</p>
<p>该集群包含 3 个节点，启动后将通过竞争选举机制产生一个 leader 节点，其它节点为阻塞状态。当 leader 节点不可用时，阻塞的节点将再次进行选举产生新的 leader 节点，从而保证服务的可用性。</p>
<p>为保证通信安全，本文档先生成 x509 证书和私钥，kube-controller-manager 在如下两种情况下使用该证书：</p>
<ol>
<li>与 kube-apiserver 的安全端口通信;</li>
<li>在安全端口(https，10252) 输出 prometheus 格式的 metrics；</li>
</ol>
<p>注意：如果没有特殊指明，本文档的所有操作均在k8s-01 节点上执行。</p>
<h3 id="创建-kube-controller-manager-证书和私钥"><a href="#创建-kube-controller-manager-证书和私钥" class="headerlink" title="创建 kube-controller-manager 证书和私钥"></a>创建 kube-controller-manager 证书和私钥</h3><h4 id="创建证书签名请求：-3"><a href="#创建证书签名请求：-3" class="headerlink" title="创建证书签名请求："></a>创建证书签名请求：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF &#123;</span><br><span class="line">	"CN": "system:kube-controller-manager",</span><br><span class="line">	"key": &#123;</span><br><span class="line">		"algo": "rsa",</span><br><span class="line">		"size": 2048</span><br><span class="line">	&#125;,</span><br><span class="line">	"hosts": [</span><br><span class="line">		"127.0.0.1",</span><br><span class="line">		"172.27.138.251",</span><br><span class="line">		"172.27.137.229",</span><br><span class="line">		<span class="string">"172.27.138.239"</span></span><br><span class="line">	],</span><br><span class="line">	"names": [&#123;</span><br><span class="line">		"C": "CN",</span><br><span class="line">		"ST": "BeiJing",</span><br><span class="line">		"L": "BeiJing",</span><br><span class="line">		"O": "system:kube-controller-manager",</span><br><span class="line">		"OU": "opsnull"</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>hosts 列表包含所有 kube-controller-manager 节点 IP；</li>
<li>CN 和 O 均为  system:kube-controller-manager  ，kubernetes 内置的ClusterRoleBindings  system:kube-controller-manager  赋予 kube-controller-manager 工作所需的权限。</li>
</ul>
<h4 id="生成证书和私钥：-3"><a href="#生成证书和私钥：-3" class="headerlink" title="生成证书和私钥："></a>生成证书和私钥：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cfssl gencert -ca=/opt/k8s/work/ca.pem \</span><br><span class="line">-ca-key=/opt/k8s/work/ca-key.pem \</span><br><span class="line">-config=/opt/k8s/work/ca-config.json \</span><br><span class="line">-profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class="line">ls kube-controller-manager*pem</span><br></pre></td></tr></table></figure>

<h4 id="将生成的证书和私钥分发到所有-master-节点："><a href="#将生成的证书和私钥分发到所有-master-节点：" class="headerlink" title="将生成的证书和私钥分发到所有 master 节点："></a>将生成的证书和私钥分发到所有 master 节点：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp kube-controller-manager*.pem root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/kubernetes/cert/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建和分发-kubeconfig-文件"><a href="#创建和分发-kubeconfig-文件" class="headerlink" title="创建和分发 kubeconfig 文件"></a>创建和分发 kubeconfig 文件</h3><p>kube-controller-manager 使用 kubeconfig 文件访问 apiserver，该文件提供了 apiserver地址、嵌入的 CA 证书和 kube-controller-manager 证书等信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/k8s/work/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="string">"https://##NODE_IP##:6443"</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials system:kube-controller-manager \</span><br><span class="line">  --client-certificate=kube-controller-manager.pem \</span><br><span class="line">  --client-key=kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">kubectl config <span class="built_in">set</span>-context system:kube-controller-manager \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-controller-manager \</span><br><span class="line">  --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>

<ul>
<li>kube-controller-manager 与 kube-apiserver 混布，故直接通过节点 IP 访问 kube-apiserver；</li>
</ul>
<h4 id="分发-kubeconfig-到所有-master-节点："><a href="#分发-kubeconfig-到所有-master-节点：" class="headerlink" title="分发 kubeconfig 到所有 master 节点："></a>分发 kubeconfig 到所有 master 节点：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">sed -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;node_ip&#125;</span>/"</span> kube-controller-manager.kubeconfig &gt; kube-controller-manager-<span class="variable">$&#123;node_ip&#125;</span>.kubeconfig</span><br><span class="line">scp kube-controller-manager-<span class="variable">$&#123;node_ip&#125;</span>.kubeconfig root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建-kube-controller-manager-systemd-unit-模板文件"><a href="#创建-kube-controller-manager-systemd-unit-模板文件" class="headerlink" title="创建 kube-controller-manager systemd unit 模板文件"></a>创建 kube-controller-manager systemd unit 模板文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kube-controller-manager.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=$&#123;K8S_DIR&#125;/kube-controller-manager</span><br><span class="line">ExecStart=/opt/k8s/bin/kube-controller-manager \\</span><br><span class="line">  --profiling \\</span><br><span class="line">  --cluster-name=kubernetes \\</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">  --kube-api-qps=1000 \\</span><br><span class="line">  --kube-api-burst=2000 \\</span><br><span class="line">  --leader-elect \\</span><br><span class="line">  --use-service-account-credentials\\</span><br><span class="line">  --concurrent-service-syncs=2 \\</span><br><span class="line">  --bind-address=##NODE_IP## \\</span><br><span class="line">  --secure-port=10252 \\</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/cert/kube-controller-manager.pem \\</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/cert/kube-controller-manager-key.pem \\</span><br><span class="line">  --port=0 \\</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  --client-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --requestheader-allowed-names="aggregator" \\</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --requestheader-extra-headers-prefix="X-Remote-Extra-" \\</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \\</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/cert/ca-key.pem \\</span><br><span class="line">  --experimental-cluster-signing-duration=876000h \\</span><br><span class="line">  --horizontal-pod-autoscaler-sync-period=10s \\</span><br><span class="line">  --concurrent-deployment-syncs=10 \\</span><br><span class="line">  --concurrent-gc-syncs=30 \\</span><br><span class="line">  --node-cidr-mask-size=24 \\</span><br><span class="line">  --service-cluster-ip-range=$&#123;SERVICE_CIDR&#125; \\</span><br><span class="line">  --pod-eviction-timeout=6m \\</span><br><span class="line">  --terminated-pod-gc-threshold=10000 \\</span><br><span class="line">  --root-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/cert/ca-key.pem \\</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  --logtostderr=true \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>--port=0</code>  ：关闭监听非安全端口（http），同时  <code>--address</code>  参数无效， <code>--bind-address</code>  参数有效；</p>
</li>
<li><p><code>--secure-port=10252</code>  、 <code>--bind-address=0.0.0.0</code>  : 在所有网络接口监听10252 端口的 https /metrics 请求；</p>
</li>
<li><p><code>--kubeconfig</code>  ：指定 kubeconfig 文件路径，kube-controller-manager 使用它连接和验证 kube-apiserver；</p>
</li>
<li><p><code>--authentication-kubeconfig</code>  和  <code>--authorization-kubeconfig</code>  ：kube-controller-manager 使用它连接 apiserver，对 client 的请求进行认证和授权。 kube-controller-manager  不再使用  -<code>-tls-ca-file</code>  对请求 httpsmetrics 的 Client 证书进行校验。如果没有配置这两个 kubeconfig 参数，则 client连接 kube-controller-manager https 端口的请求会被拒绝(提示权限不足)。</p>
</li>
<li><p><code>--cluster-signing-*-file</code>  ：签名 TLS Bootstrap 创建的证书；</p>
</li>
<li><p><code>--experimental-cluster-signing-duration</code>  ：指定 TLS Bootstrap 证书的有效期；</p>
</li>
<li><p>–root-ca-file  ：放置到容器 ServiceAccount 中的 CA 证书，用来对 kube-apiserver 的证书进行校验；</p>
</li>
<li><p><code>--service-account-private-key-file</code>  ：签名 ServiceAccount 中 Token 的私钥文件，必须和 kube-apiserver 的  –service-account-key-file  指定的公钥文件配对使用；</p>
</li>
<li><p><code>--service-cluster-ip-range</code>  ：指定 Service Cluster IP 网段，必须和 kube-apiserver 中的同名参数一致；</p>
</li>
<li><p><code>--leader-elect=true</code>  ：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</p>
</li>
<li><p><code>--controllers=*,bootstrapsigner,tokencleaner</code>  ：启用的控制器列表，tokencleaner 用于自动清理过期的 Bootstrap token；</p>
</li>
<li><p><code>--horizontal-pod-autoscaler-*</code>  ：custom metrics 相关参数，支持autoscaling/v2alpha1；</p>
</li>
<li><p><code>--tls-cert-file , --tls-private-key-file</code>  ：使用 https 输出 metrics 时使用的 Server 证书和秘钥；</p>
</li>
<li><p><code>--use-service-account-credentials=true</code>  : kube-controller-manager 中各controller 使用 serviceaccount 访问 kube-apiserver；</p>
</li>
</ul>
<h3 id="为各节点创建和分发-kube-controller-manangersystemd-unit-文件"><a href="#为各节点创建和分发-kube-controller-manangersystemd-unit-文件" class="headerlink" title="为各节点创建和分发 kube-controller-manangersystemd unit 文件"></a>为各节点创建和分发 kube-controller-manangersystemd unit 文件</h3><p>替换模板文件中的变量，为各节点创建 systemd unit 文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> (( i=0; i &lt; 3; i++ ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;NODE_NAMES[i]&#125;</span>/"</span> -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;NODE_IPS[i]&#125;</span>/"</span> kube-controller-manager.service.template &gt; kube-controller-manager-<span class="variable">$&#123;NODE_IPS[i]&#125;</span>.service</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">ls kube-controller-manager*.service</span><br></pre></td></tr></table></figure>

<p>分发到所有 master 节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp kube-controller-manager-<span class="variable">$&#123;node_ip&#125;</span>.service root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/systemd/system/kube-controller-manager.service</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="启动-kube-controller-manager-服务"><a href="#启动-kube-controller-manager-服务" class="headerlink" title="启动 kube-controller-manager 服务"></a>启动 kube-controller-manager 服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-controller-manager"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="检查服务运行状态"><a href="#检查服务运行状态" class="headerlink" title="检查服务运行状态"></a>检查服务运行状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status kube-controller-manager|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>确保状态为  active (running)  ，否则查看日志，确认原因：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">journalctl -u kube-controller-manager</span></span><br></pre></td></tr></table></figure>

<p>kube-controller-manager 监听 10252 端口，接收 https 请求：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo netstat -lnpt | grep kube-cont</span><br><span class="line">tcp 0 0 172.27.138.251:10252 0.0.0.0:* LISTEN 108977/kube-control</span><br></pre></td></tr></table></figure>

<h3 id="查看输出的-metrics"><a href="#查看输出的-metrics" class="headerlink" title="查看输出的 metrics"></a>查看输出的 metrics</h3><p>注意：以下命令在 kube-controller-manager 节点上执行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s --cacert /opt/k8s/work/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem https://172.27.138.251:10252/metrics |head</span><br><span class="line"><span class="comment"># HELP ClusterRoleAggregator_adds (Deprecated) Total number of adds handled by workqueue: ClusterRoleAggregator</span></span><br><span class="line"><span class="comment"># TYPE ClusterRoleAggregator_adds counter</span></span><br><span class="line">ClusterRoleAggregator_adds 3</span><br><span class="line"><span class="comment"># HELP ClusterRoleAggregator_depth (Deprecated) Current depth of workqueue: ClusterRoleAggregator</span></span><br><span class="line"><span class="comment"># TYPE ClusterRoleAggregator_depth gauge</span></span><br><span class="line">ClusterRoleAggregator_depth 0</span><br><span class="line"><span class="comment"># HELP ClusterRoleAggregator_longest_running_processor_microseconds (Deprecated) How many microseconds has the longest running processor for ClusterRoleAggregator been running.</span></span><br><span class="line"><span class="comment"># TYPE ClusterRoleAggregator_longest_running_processor_microseconds gauge</span></span><br><span class="line">ClusterRoleAggregator_longest_running_processor_microseconds 0</span><br><span class="line"><span class="comment"># HELP ClusterRoleAggregator_queue_latency (Deprecated) How long an item stays in workqueueClusterRoleAggregator before being requested.</span></span><br></pre></td></tr></table></figure>

<h3 id="查看当前的-leader-1"><a href="#查看当前的-leader-1" class="headerlink" title="查看当前的 leader"></a>查看当前的 leader</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get endpoints kube-controller-manager --namespace=kube-system -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">annotations:</span><br><span class="line">control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"zha</span></span><br><span class="line"><span class="string">ngjun-k8s-03_e334e88d-6b52-40e0-b2a1-a6f7e47593e1","leaseDurationSeco</span></span><br><span class="line"><span class="string">nds":15,"acquireTime":"2020-02-07T07:01:32Z","renewTime":"2020-02-07T</span></span><br><span class="line"><span class="string">07:01:44Z","leaderTransitions":1&#125;'</span></span><br><span class="line">creationTimestamp: <span class="string">"2020-02-07T06:59:38Z"</span></span><br><span class="line">name: kube-controller-manager</span><br><span class="line">namespace: kube-system</span><br><span class="line">resourceVersion: <span class="string">"561"</span></span><br><span class="line">selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-</span><br><span class="line">manager</span><br><span class="line">uid: e5d52a8c-fe69-4910-a125-d7ec97cead16</span><br></pre></td></tr></table></figure>

<p>可见，当前的 leader 为 zhangjun-k8s-03 节点。</p>
<h3 id="测试-kube-controller-manager-集群的高可用"><a href="#测试-kube-controller-manager-集群的高可用" class="headerlink" title="测试 kube-controller-manager 集群的高可用"></a>测试 kube-controller-manager 集群的高可用</h3><p>停掉一个或两个节点的 kube-controller-manager 服务，观察其它节点的日志，看是否获取了 leader 权限。</p>
<h3 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h3><ol>
<li>关于 controller 权限和 use-service-account-credentials 参数：<a href="https://github.com/kubernetes/kubernetes/issues/48208" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/issues/48208</a></li>
<li>kubelet 认证和授权：<a href="https://kubernetes.io/docs/admin/kubelet-authentication-authorization/#kubelet-authorization" target="_blank" rel="noopener">https://kubernetes.io/docs/admin/kubelet-authentication-authorization/#kubelet-authorization</a></li>
</ol>
<h2 id="部署高可用-kube-scheduler-集群"><a href="#部署高可用-kube-scheduler-集群" class="headerlink" title="部署高可用 kube-scheduler 集群"></a>部署高可用 kube-scheduler 集群</h2><p>本文档介绍部署高可用 kube-scheduler 集群的步骤。</p>
<p>该集群包含 3 个节点，启动后将通过竞争选举机制产生一个 leader 节点，其它节点为阻塞状态。当 leader 节点不可用后，剩余节点将再次进行选举产生新的 leader 节点，从而保证服务的可用性。</p>
<p>为保证通信安全，本文档先生成 x509 证书和私钥，kube-scheduler 在如下两种情况下<br>使用该证书：</p>
<ol>
<li>与 kube-apiserver 的安全端口通信;</li>
<li>在安全端口(https，10251) 输出 prometheus 格式的 metrics；</li>
<li>注意：如果没有特殊指明，本文档的所有操作均在 k8s-01 节点上执行。</li>
</ol>
<h3 id="创建-kube-scheduler-证书和私钥"><a href="#创建-kube-scheduler-证书和私钥" class="headerlink" title="创建 kube-scheduler 证书和私钥"></a>创建 kube-scheduler 证书和私钥</h3><p>创建证书签名请求：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cat &gt; kube-scheduler-csr.json &lt;&lt; EOF &#123;</span><br><span class="line">	<span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">	<span class="string">"hosts"</span>: [</span><br><span class="line">		<span class="string">"127.0.0.1"</span>,</span><br><span class="line">		<span class="string">"172.27.138.239"</span>,</span><br><span class="line">		<span class="string">"172.27.137.229"</span>,</span><br><span class="line">		<span class="string">"172.27.138.251"</span></span><br><span class="line">	],</span><br><span class="line">	<span class="string">"key"</span>: &#123;</span><br><span class="line">		<span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">		<span class="string">"size"</span>: 2048</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"names"</span>: [&#123;</span><br><span class="line">		<span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">		<span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">		<span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">		<span class="string">"O"</span>: <span class="string">"system:kube-scheduler"</span>,</span><br><span class="line">		<span class="string">"OU"</span>: <span class="string">"opsnull"</span></span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>hosts 列表包含所有 kube-scheduler 节点 IP；</li>
<li>CN 和 O 均为  system:kube-scheduler  ，kubernetes 内置的ClusterRoleBindings  system:kube-scheduler  将赋予 kube-scheduler 工作所需的权限；</li>
</ul>
<p>生成证书和私钥：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cfssl gencert -ca=/opt/k8s/work/ca.pem \</span><br><span class="line">-ca-key=/opt/k8s/work/ca-key.pem \</span><br><span class="line">-config=/opt/k8s/work/ca-config.json \</span><br><span class="line">-profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line">ls kube-scheduler*pem</span><br></pre></td></tr></table></figure>

<p>将生成的证书和私钥分发到所有 master 节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp kube-scheduler*.pem root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/kubernetes/cert/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建和分发-kubeconfig-文件-1"><a href="#创建和分发-kubeconfig-文件-1" class="headerlink" title="创建和分发 kubeconfig 文件"></a>创建和分发 kubeconfig 文件</h3><p>kube-scheduler 使用 kubeconfig 文件访问 apiserver，该文件提供了 apiserver 地址、嵌入的 CA 证书和 kube-scheduler 证书：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/k8s/work/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="string">"https://##NODE_IP##:6443"</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials system:kube-scheduler \</span><br><span class="line">  --client-certificate=kube-scheduler.pem \</span><br><span class="line">  --client-key=kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">kubectl config <span class="built_in">set</span>-context system:kube-scheduler \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=system:kube-scheduler \</span><br><span class="line">  --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-scheduler --kubeconfig=kube-sc</span><br><span class="line">heduler.kubeconfig</span><br></pre></td></tr></table></figure>

<p>分发 kubeconfig 到所有 master 节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">sed -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;node_ip&#125;</span>/"</span> kube-scheduler.kubeconfig &gt; kube-scheduler-<span class="variable">$&#123;node_ip&#125;</span>.kubeconfig</span><br><span class="line">scp kube-scheduler-<span class="variable">$&#123;node_ip&#125;</span>.kubeconfig root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建-kube-scheduler-配置文件"><a href="#创建-kube-scheduler-配置文件" class="headerlink" title="创建 kube-scheduler 配置文件"></a>创建 kube-scheduler 配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cat &gt;kube-scheduler.yaml.template &lt;&lt;EOF</span><br><span class="line">apiVersion: kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeSchedulerConfiguration</span><br><span class="line">bindTimeoutSeconds: 600</span><br><span class="line">clientConnection:</span><br><span class="line">	burst: 200</span><br><span class="line">	kubeconfig: <span class="string">"/etc/kubernetes/kube-scheduler.kubeconfig"</span></span><br><span class="line">	qps: 100</span><br><span class="line">enableContentionProfiling: <span class="literal">false</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">hardPodAffinitySymmetricWeight: 1</span><br><span class="line">healthzBindAddress: <span class="comment">##NODE_IP##:10251</span></span><br><span class="line">leaderElection:</span><br><span class="line">	leaderElect: <span class="literal">true</span></span><br><span class="line">metricsBindAddress: <span class="comment">##NODE_IP##:10251</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>–kubeconfig  ：指定 kubeconfig 文件路径，kube-scheduler 使用它连接和验证kube-apiserver；</li>
<li>–leader-elect=true  ：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</li>
</ul>
<p>替换模板文件中的变量：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> (( i=0; i &lt; 3; i++ ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;NODE_NAMES[i]&#125;</span>/"</span> -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;NODE_IPS[i]&#125;</span>/"</span> kube-scheduler.yaml.template &gt; kube-scheduler-<span class="variable">$&#123;NODE_IPS[i]&#125;</span>.yaml</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">ls kube-scheduler*.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>NODE_NAMES 和 NODE_IPS 为相同长度的 bash 数组，分别为节点名称和对应的 IP；</li>
</ul>
<p>分发 kube-scheduler 配置文件到所有 master 节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp kube-scheduler-<span class="variable">$&#123;node_ip&#125;</span>.yaml root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/kubernetes/kube-scheduler.yaml</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>重命名为 kube-scheduler.yaml;</p>
<h3 id="创建-kube-scheduler-systemd-unit-模板文件"><a href="#创建-kube-scheduler-systemd-unit-模板文件" class="headerlink" title="创建 kube-scheduler systemd unit 模板文件"></a>创建 kube-scheduler systemd unit 模板文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kube-scheduler.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-scheduler</span><br><span class="line">ExecStart=/opt/k8s/bin/kube-scheduler \\</span><br><span class="line">  --config=/etc/kubernetes/kube-scheduler.yaml \\</span><br><span class="line">  --<span class="built_in">bind</span>-address=<span class="comment">##NODE_IP## \\</span></span><br><span class="line">  --secure-port=10259 \\</span><br><span class="line">  --port=0 \\</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/cert/kube-scheduler.pem \\</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/cert/kube-scheduler-key.pem \\</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  --client-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --requestheader-allowed-names=<span class="string">""</span> \\</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --requestheader-extra-headers-prefix=<span class="string">"X-Remote-Extra-"</span> \\</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \\</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="为各节点创建和分发-kube-scheduler-systemd-unit文件"><a href="#为各节点创建和分发-kube-scheduler-systemd-unit文件" class="headerlink" title="为各节点创建和分发 kube-scheduler systemd unit文件"></a>为各节点创建和分发 kube-scheduler systemd unit文件</h3><p>替换模板文件中的变量，为各节点创建 systemd unit 文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> (( i=0; i &lt; 3; i++ ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;NODE_NAMES[i]&#125;</span>/"</span> -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;NODE_IPS[i]&#125;</span>/"</span> kube-scheduler.service.template &gt; kube-scheduler-<span class="variable">$&#123;NODE_IPS[i]&#125;</span>.service</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">ls kube-scheduler*.service</span><br></pre></td></tr></table></figure>

<p>分发 systemd unit 文件到所有 master 节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp kube-scheduler-<span class="variable">$&#123;node_ip&#125;</span>.service root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/systemd/system/kube-scheduler.service</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="启动-kube-scheduler-服务"><a href="#启动-kube-scheduler-服务" class="headerlink" title="启动 kube-scheduler 服务"></a>启动 kube-scheduler 服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-scheduler"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="检查服务运行状态-1"><a href="#检查服务运行状态-1" class="headerlink" title="检查服务运行状态"></a>检查服务运行状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status kube-scheduler|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>确保状态为  active (running)  ，否则查看日志，确认原因：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">journalctl </span>-u kube-<span class="keyword">scheduler </span>-f</span><br></pre></td></tr></table></figure>

<h3 id="查看输出的-metrics-1"><a href="#查看输出的-metrics-1" class="headerlink" title="查看输出的 metrics"></a>查看输出的 metrics</h3><p>注意：以下命令在 kube-scheduler 节点上执行。</p>
<p>kube-scheduler 监听 10251 和 10259 端口：</p>
<ul>
<li><p>10251：接收 http 请求，非安全端口，不需要认证授权；</p>
</li>
<li><p>10259：接收 https 请求，安全端口，需要认证授权；</p>
</li>
</ul>
<p>两个接口都对外提供  /metrics  和  /healthz  的访问。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo netstat -lnpt |grep kube-sch</span><br><span class="line">tcp 0 0 172.27.138.251:10251 0.0.0.0:* LISTEN 114702/kube-schedul</span><br><span class="line">tcp 0 0 172.27.138.251:10259 0.0.0.0:* LISTEN 114702/kube-schedul</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s http://172.27.138.251:10251/metrics |head</span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generatedand sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s --cacert /opt/k8s/work/ca.pem --cert /opt/k8s/work/admin.pe</span><br><span class="line">m --key /opt/k8s/work/admin-key.pem https://172.27.138.251:10259/metr</span><br><span class="line">ics |head</span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generatedand sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure>

<h3 id="查看当前的-leader-2"><a href="#查看当前的-leader-2" class="headerlink" title="查看当前的 leader"></a>查看当前的 leader</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get endpoints kube-scheduler --namespace=kube-system -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">annotations:</span><br><span class="line">control-plane.alpha.kubernetes.io/leader: <span class="string">'&#123;"holderIdentity":"zha</span></span><br><span class="line"><span class="string">ngjun-k8s-01_ce04632e-64e4-477e-b8f0-4e69020cd996","leaseDurationSeco</span></span><br><span class="line"><span class="string">nds":15,"acquireTime":"2020-02-07T07:05:00Z","renewTime":"2020-02-07T</span></span><br><span class="line"><span class="string">07:05:28Z","leaderTransitions":0&#125;'</span></span><br><span class="line">creationTimestamp: <span class="string">"2020-02-07T07:05:00Z"</span></span><br><span class="line">name: kube-scheduler</span><br><span class="line">namespace: kube-system</span><br><span class="line">resourceVersion: <span class="string">"756"</span></span><br><span class="line">selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler</span><br><span class="line">uid: 1b687724-a6e2-4404-9efb-a1f0e201fecc</span><br></pre></td></tr></table></figure>

<p>可见，当前的 leader 为 k8s-01 节点。</p>
<h3 id="测试-kube-scheduler-集群的高可用"><a href="#测试-kube-scheduler-集群的高可用" class="headerlink" title="测试 kube-scheduler 集群的高可用"></a>测试 kube-scheduler 集群的高可用</h3><p>随便找一个或两个 master 节点，停掉 kube-scheduler 服务，看其它节点是否获取了leader 权限。</p>
<h1 id="部署-worker-节点"><a href="#部署-worker-节点" class="headerlink" title="部署 worker 节点"></a>部署 worker 节点</h1><p>kubernetes worker 节点运行如下组件：</p>
<ul>
<li>containerd</li>
<li>kubelet</li>
<li>kube-proxy</li>
<li>calico</li>
<li>kube-nginx</li>
</ul>
<p>注意：如果没有特殊指明，本文档的所有操作均在k8s-01 节点上执行。</p>
<h2 id="安装依赖包-1"><a href="#安装依赖包-1" class="headerlink" title="安装依赖包"></a>安装依赖包</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"yum install -y epel-release"</span> &amp;</span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"yum install -y chrony conntrack ipvsadm ipset jq iptables curl sysstat libseccomp wget socat git"</span> &amp;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="apiserver-高可用"><a href="#apiserver-高可用" class="headerlink" title="apiserver 高可用"></a>apiserver 高可用</h2><p>本文档讲解使用 nginx 4 层透明代理功能实现 Kubernetes worker 节点组件高可用访问kube-apiserver 集群的步骤。<br>注意：如果没有特殊指明，本文档的所有操作均在 k8s-01 节点上执行。</p>
<ul>
<li>控制节点的 kube-controller-manager、kube-scheduler 是多实例部署且连接本机的kube-apiserver，所以只要有一个实例正常，就可以保证高可用；</li>
<li>集群内的 Pod 使用 K8S 服务域名 kubernetes 访问 kube-apiserver， kube-dns 会自动解析出多个 kube-apiserver 节点的 IP，所以也是高可用的；</li>
<li>在每个节点起一个 nginx 进程，后端对接多个 apiserver 实例，nginx 对它们做健康检查和负载均衡；<br>kubelet、kube-proxy 通过本地的 nginx（监听 127.0.0.1）访问 kube-apiserver，从而实现 kube-apiserver 的高可用；</li>
</ul>
<h2 id="下载和编译-nginx"><a href="#下载和编译-nginx" class="headerlink" title="下载和编译 nginx"></a>下载和编译 nginx</h2><p>下载源码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">wget http://nginx.org/download/nginx-1.15.3.tar.gz</span><br><span class="line">tar -xzvf nginx-1.15.3.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="配置编译参数："><a href="#配置编译参数：" class="headerlink" title="配置编译参数："></a>配置编译参数：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work/nginx-1.15.3</span><br><span class="line">mkdir nginx-prefix</span><br><span class="line">yum install -y gcc make</span><br><span class="line">./configure --with-stream --without-http --prefix=$(<span class="built_in">pwd</span>)/nginx-prefix --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module</span><br></pre></td></tr></table></figure>

<ul>
<li>–with-stream  ：开启 4 层透明转发(TCP Proxy)功能；</li>
<li>–without-xxx  ：关闭所有其他功能，这样生成的动态链接二进制程序依赖最小；</li>
</ul>
<h3 id="编译和安装："><a href="#编译和安装：" class="headerlink" title="编译和安装："></a>编译和安装：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work/nginx-1.15.3</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3 id="验证编译的-nginx"><a href="#验证编译的-nginx" class="headerlink" title="验证编译的 nginx"></a>验证编译的 nginx</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work/nginx-1.15.3</span><br><span class="line">./nginx-prefix/sbin/nginx -v</span><br><span class="line">nginx version: nginx/1.15.3</span><br></pre></td></tr></table></figure>

<h2 id="安装和部署-nginx"><a href="#安装和部署-nginx" class="headerlink" title="安装和部署 nginx"></a>安装和部署 nginx</h2><h3 id="创建目录结构："><a href="#创建目录结构：" class="headerlink" title="创建目录结构："></a>创建目录结构：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p /opt/k8s/kube-nginx/&#123;conf,logs,sbin&#125;"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="拷贝二进制程序："><a href="#拷贝二进制程序：" class="headerlink" title="拷贝二进制程序："></a>拷贝二进制程序：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p /opt/k8s/kube-nginx/&#123;conf,logs,sbin&#125;"</span></span><br><span class="line">scp /opt/k8s/work/nginx-1.15.3/nginx-prefix/sbin/nginx root@<span class="variable">$&#123;node_ip&#125;</span>:/opt/k8s/kube-nginx/sbin/kube-nginx</span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"chmod a+x /opt/k8s/kube-nginx/sbin/*"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>重命名二进制文件为 kube-nginx；</li>
</ul>
<h3 id="配置-nginx，开启-4-层透明转发功能："><a href="#配置-nginx，开启-4-层透明转发功能：" class="headerlink" title="配置 nginx，开启 4 层透明转发功能："></a>配置 nginx，开启 4 层透明转发功能：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cat &gt; kube-nginx.conf &lt;&lt; \EOF</span><br><span class="line">worker_processes 1;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">	worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">  upstream backend &#123;</span><br><span class="line">    <span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent;</span><br><span class="line">      server 172.27.138.251:6443 max_fails=3 fail_timeout=30s;</span><br><span class="line">      server 172.27.137.229:6443 max_fails=3 fail_timeout=30s;</span><br><span class="line">      server 172.27.138.239:6443 max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">server &#123;</span><br><span class="line">  listen 127.0.0.1:8443;</span><br><span class="line">  proxy_connect_timeout 1s;</span><br><span class="line">  proxy_pass backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>upstream backend  中的 server 列表为集群中各 kube-apiserver 的节点 IP，需要根据实际情况修改；</li>
</ul>
<p>分发配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp kube-nginx.conf root@<span class="variable">$&#123;node_ip&#125;</span>:/opt/k8s/kube-nginx/conf/kube-nginx.conf</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="配置-systemd-unit-文件，启动服务"><a href="#配置-systemd-unit-文件，启动服务" class="headerlink" title="配置 systemd unit 文件，启动服务"></a>配置 systemd unit 文件，启动服务</h3><p>配置 kube-nginx systemd unit 文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cat &gt; kube-nginx.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=kube-apiserver nginx proxy</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStartPre=/opt/k8s/kube-nginx/sbin/kube-nginx -c /opt/k8s/kube-ngi</span><br><span class="line">nx/conf/kube-nginx.conf -p /opt/k8s/kube-nginx -t</span><br><span class="line">ExecStart=/opt/k8s/kube-nginx/sbin/kube-nginx -c /opt/k8s/kube-nginx/</span><br><span class="line">conf/kube-nginx.conf -p /opt/k8s/kube-nginx</span><br><span class="line">ExecReload=/opt/k8s/kube-nginx/sbin/kube-nginx -c /opt/k8s/kube-nginx</span><br><span class="line">/conf/kube-nginx.conf -p /opt/k8s/kube-nginx -s reload</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="分发-systemd-unit-文件："><a href="#分发-systemd-unit-文件：" class="headerlink" title="分发 systemd unit 文件："></a>分发 systemd unit 文件：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp kube-nginx.service root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/systemd/system/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="启动-kube-nginx-服务："><a href="#启动-kube-nginx-服务：" class="headerlink" title="启动 kube-nginx 服务："></a>启动 kube-nginx 服务：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-nginx &amp;&amp; systemctl restart kube-nginx"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="检查-kube-nginx-服务运行状态"><a href="#检查-kube-nginx-服务运行状态" class="headerlink" title="检查 kube-nginx 服务运行状态"></a>检查 kube-nginx 服务运行状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status kube-nginx |grep 'Active:'"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#确保状态为  active (running)  ，否则查看日志，确认原因：</span></span><br><span class="line">journalctl -u kube-nginx</span><br></pre></td></tr></table></figure>

<h2 id="部署-containerd-组件"><a href="#部署-containerd-组件" class="headerlink" title="部署 containerd 组件"></a>部署 containerd 组件</h2><p>containerd 实现了 kubernetes 的 Container Runtime Interface (CRI) 接口，提供容器运行时核心功能，如镜像管理、容器管理等，相比 dockerd 更加简单、健壮和可移植。</p>
<p>注意：</p>
<ol>
<li>如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s01 节点上执行。</li>
<li>如果想使用 docker，请参考附件 F.部署docker.md；</li>
<li>docker 需要与 flannel 配合使用，且先安装 flannel；</li>
</ol>
<h3 id="下载和分发二进制文件"><a href="#下载和分发二进制文件" class="headerlink" title="下载和分发二进制文件"></a>下载和分发二进制文件</h3><p>下载二进制文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.17.0/crictl-v1.17.0-linux-amd64.tar.gz \</span><br><span class="line">https://github.com/opencontainers/runc/releases/download/v1.0.0-rc10/runc.amd64 \</span><br><span class="line">https://github.com/containernetworking/plugins/releases/download/v0.8.5/cni-plugins-linux-amd64-v0.8.5.tgz \</span><br><span class="line">https://github.com/containerd/containerd/releases/download/v1.3.3/containerd-1.3.3.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">mkdir containerd</span><br><span class="line">tar -xvf containerd-1.3.3.linux-amd64.tar.gz -C containerd</span><br><span class="line">tar -xvf crictl-v1.17.0-linux-amd64.tar.gz</span><br><span class="line">mkdir cni-plugins</span><br><span class="line">sudo tar -xvf cni-plugins-linux-amd64-v0.8.5.tgz -C cni-plugins</span><br><span class="line">sudo mv runc.amd64 runc</span><br></pre></td></tr></table></figure>

<p>分发二进制文件到所有 worker 节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp containerd/bin/* crictl cni-plugins/* runc root@<span class="variable">$&#123;node_ip&#125;</span>:/opt/k8s/bin</span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"chmod a+x /opt/k8s/bin/* &amp;&amp; mkdir -p /etc/cni/net.d"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建和分发-containerd-配置文件"><a href="#创建和分发-containerd-配置文件" class="headerlink" title="创建和分发 containerd 配置文件"></a>创建和分发 containerd 配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">cat &lt;&lt; EOF | sudo tee containerd-config.toml</span><br><span class="line">version = 2</span><br><span class="line">root = <span class="string">"<span class="variable">$&#123;CONTAINERD_DIR&#125;</span>/root"</span></span><br><span class="line">state = <span class="string">"<span class="variable">$&#123;CONTAINERD_DIR&#125;</span>/state"</span></span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">	[plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>]</span><br><span class="line">		sandbox_image = <span class="string">"registry.cn-beijing.aliyuncs.com/images_k8s/paus</span></span><br><span class="line"><span class="string">e-amd64:3.1"</span></span><br><span class="line">		[plugins.<span class="string">"io.containerd.grpc.v1.cri"</span>.cni]</span><br><span class="line">			bin_dir = <span class="string">"/opt/k8s/bin"</span></span><br><span class="line">			conf_dir = <span class="string">"/etc/cni/net.d"</span></span><br><span class="line">	[plugins.<span class="string">"io.containerd.runtime.v1.linux"</span>]</span><br><span class="line">    shim = <span class="string">"containerd-shim"</span></span><br><span class="line">    runtime = <span class="string">"runc"</span></span><br><span class="line">    runtime_root = <span class="string">""</span></span><br><span class="line">    no_shim = <span class="literal">false</span></span><br><span class="line">    shim_debug = <span class="literal">false</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p /etc/containerd/ <span class="variable">$&#123;CONTAINERD_DIR&#125;</span>/&#123;root,state&#125;"</span></span><br><span class="line">scp containerd-config.toml root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/containerd/config.toml</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建-containerd-systemd-unit-文件"><a href="#创建-containerd-systemd-unit-文件" class="headerlink" title="创建 containerd systemd unit 文件"></a>创建 containerd systemd unit 文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cat &lt;&lt;EOF | sudo tee containerd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"PATH=/opt/k8s/bin:/bin:/sbin:/usr/bin:/usr/sbin"</span></span><br><span class="line">ExecStartPre=/sbin/modprobe overlay</span><br><span class="line">ExecStart=/opt/k8s/bin/containerd</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="分发-systemd-unit-文件，启动-containerd-服务"><a href="#分发-systemd-unit-文件，启动-containerd-服务" class="headerlink" title="分发 systemd unit 文件，启动 containerd 服务"></a>分发 systemd unit 文件，启动 containerd 服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp containerd.service root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/systemd/system</span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl enable containerd &amp;&amp; systemctl restart containerd"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建和分发-crictl-配置文件"><a href="#创建和分发-crictl-配置文件" class="headerlink" title="创建和分发 crictl 配置文件"></a>创建和分发 crictl 配置文件</h3><p>crictl 是兼容 CRI 容器运行时的命令行工具，提供类似于 docker 命令的功能。具体参考官方文档。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cat &lt;&lt; EOF | sudo tee crictl.yaml</span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>分发到所有 worker 节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">scp crictl.yaml root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/crictl.yaml</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="部署-kubelet-组件"><a href="#部署-kubelet-组件" class="headerlink" title="部署 kubelet 组件"></a>部署 kubelet 组件</h2><p>kubelet 运行在每个 worker 节点上，接收 kube-apiserver 发送的请求，管理 Pod 容器，执行交互式命令，如 exec、run、logs 等。</p>
<p>kubelet 启动时自动向 kube-apiserver 注册节点信息，内置的 cadvisor 统计和监控节点的资源使用情况。</p>
<p>为确保安全，部署时关闭了 kubelet 的非安全 http 端口，对请求进行认证和授权，拒绝未授权的访问(如 apiserver、heapster 的请求)。</p>
<p>注意：如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s-01 节点上执行。</p>
<h3 id="下载和分发-kubelet-二进制文件"><a href="#下载和分发-kubelet-二进制文件" class="headerlink" title="下载和分发 kubelet 二进制文件"></a>下载和分发 kubelet 二进制文件</h3><p>参考 05-1.部署master节点。</p>
<h3 id="创建-kubelet-bootstrap-kubeconfig-文件"><a href="#创建-kubelet-bootstrap-kubeconfig-文件" class="headerlink" title="创建 kubelet bootstrap kubeconfig 文件"></a>创建 kubelet bootstrap kubeconfig 文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line"><span class="comment"># 创建 token</span></span><br><span class="line"><span class="built_in">export</span> BOOTSTRAP_TOKEN=$(kubeadm token create \</span><br><span class="line">--description kubelet-bootstrap-token \</span><br><span class="line">--groups system:bootstrappers:<span class="variable">$&#123;node_name&#125;</span> \</span><br><span class="line">--kubeconfig ~/.kube/config)</span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">--certificate-authority=/etc/kubernetes/cert/ca.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">--kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">--token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">--kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=kubelet-bootstrap \</span><br><span class="line">--kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>向 kubeconfig 写入的是 token，bootstrap 结束后 kube-controller-manager 为kubelet 创建 client 和 server 证书；</li>
</ul>
<p>查看 kubeadm 为各节点创建的 token：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm token list --kubeconfig ~/.kube/config</span><br><span class="line">TOKEN TTL EXPIRES USAGE</span><br><span class="line">S DESCRIPTION EXTRA GROUPS</span><br><span class="line">2sb8wy.euialqfpxfbcljby 23h 2020-02-08T15:36:30+08:00 authe</span><br><span class="line">ntication,signing kubelet-bootstrap-token system:bootstrappers:zh</span><br><span class="line">angjun-k8s-02</span><br><span class="line">ta7onm.fcen74h0mczyfbz2 23h 2020-02-08T15:36:30+08:00 authe</span><br><span class="line">ntication,signing kubelet-bootstrap-token system:bootstrappers:zh</span><br><span class="line">angjun-k8s-01</span><br><span class="line">xk27zp.tylnvywx9kc8sq87 23h 2020-02-08T15:36:30+08:00 authe</span><br><span class="line">ntication,signing kubelet-bootstrap-token system:bootstrappers:zh</span><br><span class="line">angjun-k8s-03</span><br></pre></td></tr></table></figure>

<ul>
<li><p>token 有效期为 1 天，超期后将不能再被用来 boostrap kubelet，且会被 kube-controller-manager 的 tokencleaner 清理；</p>
</li>
<li><p>kube-apiserver 接收 kubelet 的 bootstrap token 后，将请求的 user 设置为system:bootstrap:<Token id>  ，group 设置为  system:bootstrappers  ，后续将为这个 group 设置 ClusterRoleBinding；</Token></p>
</li>
</ul>
<h3 id="分发-bootstrap-kubeconfig-文件到所有-worker-节点"><a href="#分发-bootstrap-kubeconfig-文件到所有-worker-节点" class="headerlink" title="分发 bootstrap kubeconfig 文件到所有 worker 节点"></a>分发 bootstrap kubeconfig 文件到所有 worker 节点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">scp kubelet-bootstrap-<span class="variable">$&#123;node_name&#125;</span>.kubeconfig root@<span class="variable">$&#123;node_name&#125;</span>:/etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建和分发-kubelet-参数配置文件"><a href="#创建和分发-kubelet-参数配置文件" class="headerlink" title="创建和分发 kubelet 参数配置文件"></a>创建和分发 kubelet 参数配置文件</h3><p>从 v1.10 开始，部分 kubelet 参数需在配置文件中配置， kubelet –help  会提示：</p>
<p><code>DEPRECATED: This parameter should be set via the config file specified by the Kubelet&#39;s --config flag</code></p>
<p>创建 kubelet 参数配置文件模板（可配置项参考代码中注释）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/work</span></span><br><span class="line"><span class="string">source</span> <span class="string">/opt/k8s/bin/environment.sh</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">kubelet-config.yaml.template</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">address:</span> <span class="string">"##NODE_IP##"</span></span><br><span class="line"><span class="attr">staticPodPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">syncFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">fileCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">httpCheckFrequency:</span> <span class="string">20s</span></span><br><span class="line"><span class="attr">staticPodURL:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="attr">readOnlyPort:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">rotateCertificates:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">serverTLSBootstrap:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">authentication:</span></span><br><span class="line">	<span class="attr">anonymous:</span></span><br><span class="line">		<span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">	<span class="attr">webhook:</span></span><br><span class="line">		<span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">	<span class="attr">x509:</span></span><br><span class="line">		<span class="attr">clientCAFile:</span> <span class="string">"/etc/kubernetes/cert/ca.pem"</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">	<span class="attr">mode:</span> <span class="string">Webhook</span></span><br><span class="line"><span class="attr">registryPullQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">registryBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">eventRecordQPS:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">eventBurst:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">enableDebuggingHandlers:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enableContentionProfiling:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">healthzPort:</span> <span class="number">10248</span></span><br><span class="line"><span class="attr">healthzBindAddress:</span> <span class="string">"##NODE_IP##"</span></span><br><span class="line"><span class="attr">clusterDomain:</span> <span class="string">"$&#123;CLUSTER_DNS_DOMAIN&#125;"</span></span><br><span class="line"><span class="attr">clusterDNS:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">"$&#123;CLUSTER_DNS_SVC_IP&#125;"</span></span><br><span class="line"><span class="attr">nodeStatusUpdateFrequency:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">nodeStatusReportFrequency:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">imageMinimumGCAge:</span> <span class="string">2m</span></span><br><span class="line"><span class="attr">imageGCHighThresholdPercent:</span> <span class="number">85</span></span><br><span class="line"><span class="attr">imageGCLowThresholdPercent:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">volumeStatsAggPeriod:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">kubeletCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">systemCgroups:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupRoot:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">cgroupsPerQOS:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">cgroupfs</span></span><br><span class="line"><span class="attr">runtimeRequestTimeout:</span> <span class="string">10m</span></span><br><span class="line"><span class="attr">hairpinMode:</span> <span class="string">promiscuous-bridge</span></span><br><span class="line"><span class="attr">maxPods:</span> <span class="number">220</span></span><br><span class="line"><span class="attr">podCIDR:</span> <span class="string">"$&#123;CLUSTER_CIDR&#125;"</span></span><br><span class="line"><span class="attr">podPidsLimit:</span> <span class="number">-1</span></span><br><span class="line"><span class="attr">resolvConf:</span> <span class="string">/etc/resolv.conf</span></span><br><span class="line"><span class="attr">maxOpenFiles:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">kubeAPIQPS:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">kubeAPIBurst:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">serializeImagePulls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">evictionHard:</span></span><br><span class="line">  <span class="attr">memory.available:</span> <span class="string">"100Mi"</span></span><br><span class="line">  <span class="attr">nodefs.available:</span> <span class="string">"10%"</span></span><br><span class="line">  <span class="attr">nodefs.inodesFree:</span> <span class="string">"5%"</span></span><br><span class="line">  <span class="attr">imagefs.available:</span> <span class="string">"15%"</span></span><br><span class="line"><span class="attr">evictionSoft:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">enableControllerAttachDetach:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">failSwapOn:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">containerLogMaxSize:</span> <span class="string">20Mi</span></span><br><span class="line"><span class="attr">containerLogMaxFiles:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">systemReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">kubeReserved:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">systemReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">kubeReservedCgroup:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">enforceNodeAllocatable:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>address：kubelet 安全端口（https，10250）监听的地址，不能为 127.0.0.1，否则kube-apiserver、heapster 等不能调用 kubelet 的 API；</li>
<li>readOnlyPort=0：关闭只读端口(默认 10255)，等效为未指定；</li>
<li>authentication.anonymous.enabled：设置为 false，不允许匿名访问 10250 端口；</li>
<li>authentication.x509.clientCAFile：指定签名客户端证书的 CA 证书，开启 HTTP 证书认证；</li>
<li>authentication.webhook.enabled=true：开启 HTTPs bearer token 认证；</li>
<li>对于未通过 x509 证书和 webhook 认证的请求(kube-apiserver 或其他客户端)，将被拒绝，提示 Unauthorized；</li>
<li>authroization.mode=Webhook：kubelet 使用 SubjectAccessReview API 查询kube-apiserver 某 user、group 是否具有操作资源的权限(RBAC)；</li>
<li>featureGates.RotateKubeletClientCertificate、featureGates.RotateKubeletServerCertificate：自动 rotate 证书，证书的有效期取决于 kube-controller-manager 的 –experimental-cluster-signing-duration 参数；</li>
<li>需要 root 账户运行；</li>
</ul>
<p>为各节点创建和分发 kubelet 配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">sed -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;node_ip&#125;</span>/"</span> kubelet-config.yaml.template &gt;</span><br><span class="line">kubelet-config-<span class="variable">$&#123;node_ip&#125;</span>.yaml.template</span><br><span class="line">scp kubelet-config-<span class="variable">$&#123;node_ip&#125;</span>.yaml.template root@<span class="variable">$&#123;node_ip&#125;</span>:/etc/kubernetes/kubelet-config.yaml</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建和分发-kubelet-systemd-unit-文件"><a href="#创建和分发-kubelet-systemd-unit-文件" class="headerlink" title="创建和分发 kubelet systemd unit 文件"></a>创建和分发 kubelet systemd unit 文件</h3><p>创建 kubelet systemd unit 文件模板：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kubelet.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=containerd.service</span><br><span class="line">Requires=containerd.service</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet</span><br><span class="line">ExecStart=/opt/k8s/bin/kubelet \\</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\</span><br><span class="line">  --cert-dir=/etc/kubernetes/cert \\</span><br><span class="line">  --network-plugin=cni \\</span><br><span class="line">  --cni-conf-dir=/etc/cni/net.d \\</span><br><span class="line">  --container-runtime=remote \\</span><br><span class="line">  --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\</span><br><span class="line">  --root-dir=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet \\</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">  --config=/etc/kubernetes/kubelet-config.yaml \\</span><br><span class="line">  --hostname-override=<span class="comment">##NODE_NAME## \\</span></span><br><span class="line">  --image-pull-progress-deadline=15m \\</span><br><span class="line">  --volume-plugin-dir=<span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet/kubelet-plugins/volume/<span class="built_in">exec</span>/ \\</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>如果设置了  –hostname-override  选项，则  kube-proxy  也需要设置该选项，否则会出现找不到 Node 的情况；</li>
<li>–bootstrap-kubeconfig  ：指向 bootstrap kubeconfig 文件，kubelet 使用该文件中的用户名和 token 向 kube-apiserver 发送 TLS Bootstrapping 请求；</li>
<li>K8S approve kubelet 的 csr 请求后，在  –cert-dir  目录创建证书和私钥文件，然后写入  –kubeconfig  文件；</li>
<li>–pod-infra-container-image  不使用 redhat 的  pod-infrastructure:latest  镜像，它不能回收僵尸容器；</li>
</ul>
<p>为各节点创建和分发 kubelet systemd unit 文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;node_name&#125;</span>/"</span> kubelet.service.template &gt; kubelet-<span class="variable">$&#123;node_name&#125;</span>.service</span><br><span class="line">scp kubelet-<span class="variable">$&#123;node_name&#125;</span>.service root@<span class="variable">$&#123;node_name&#125;</span>:/etc/systemd/system/kubelet.service</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="授予-kube-apiserver-访问-kubelet-API-的权限"><a href="#授予-kube-apiserver-访问-kubelet-API-的权限" class="headerlink" title="授予 kube-apiserver 访问 kubelet API 的权限"></a>授予 kube-apiserver 访问 kubelet API 的权限</h3><p>在执行 kubectl exec、run、logs 等命令时，apiserver 会将请求转发到 kubelet 的 https端口。这里定义 RBAC 规则，授权 apiserver 使用的证书（kubernetes.pem）用户名（CN：kuberntes-master）访问 kubelet API 的权限：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes-master</span><br></pre></td></tr></table></figure>

<h3 id="Bootstrap-Token-Auth-和授予权限"><a href="#Bootstrap-Token-Auth-和授予权限" class="headerlink" title="Bootstrap Token Auth 和授予权限"></a>Bootstrap Token Auth 和授予权限</h3><p>kubelet 启动时查找  –kubeletconfig  参数对应的文件是否存在，如果不存在则使用–bootstrap-kubeconfig  指定的 kubeconfig 文件向 kube-apiserver 发送证书签名请求 (CSR)。</p>
<p>kube-apiserver 收到 CSR 请求后，对其中的 Token 进行认证，认证通过后将请求的user 设置为  system:bootstrap:<Token id>  ，group 设置为system:bootstrappers  ，这一过程称为  Bootstrap Token Auth  。</Token></p>
<p>默认情况下，这个 user 和 group 没有创建 CSR 的权限，kubelet 启动失败，错误日志如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo journalctl -u kubelet -a |grep -A 2 <span class="string">'certificatesigningrequests'</span></span><br><span class="line">May 26 12:13:41 zhangjun-k8s-01 kubelet[128468]: I0526 12:13:41.79823</span><br><span class="line">0 128468 certificate_manager.go:366] Rotating certificates</span><br><span class="line">May 26 12:13:41 zhangjun-k8s-01 kubelet[128468]: E0526 12:13:41.80199</span><br><span class="line">7 128468 certificate_manager.go:385] Failed <span class="keyword">while</span> requesting a signe</span><br><span class="line">d certificate from the master: cannot create certificate signing requ</span><br><span class="line">est: certificatesigningrequests.certificates.k8s.io is forbidden: Use</span><br><span class="line">r <span class="string">"system:bootstrap:82jfrm"</span> cannot create resource <span class="string">"certificatesignin</span></span><br><span class="line"><span class="string">grequests"</span> <span class="keyword">in</span> API group <span class="string">"certificates.k8s.io"</span> at the cluster scope</span><br></pre></td></tr></table></figure>

<p>解决办法是：创建一个 clusterrolebinding，将 group system:bootstrappers 和clusterrole system:node-bootstrapper 绑定：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span><br></pre></td></tr></table></figure>

<h3 id="自动-approve-CSR-请求，生成-kubelet-client-证书"><a href="#自动-approve-CSR-请求，生成-kubelet-client-证书" class="headerlink" title="自动 approve CSR 请求，生成 kubelet client 证书"></a>自动 approve CSR 请求，生成 kubelet client 证书</h3><p><strong>kubelet 创建 CSR 请求后，下一步需要创建被 approve，有两种方式：</strong></p>
<ol>
<li><strong>kube-controller-manager 自动 aprrove；</strong></li>
<li><strong>手动使用命令  kubectl certificate approve  ；</strong></li>
</ol>
<p><strong>CSR 被 approve 后，kubelet 向 kube-controller-manager 请求创建 client 证书，kube-controller-manager 中的  csrapproving  controller 使用  SubjectAccessReview  API来检查 kubelet 请求（对应的 group 是 system:bootstrappers）是否具有相应的权限。创建三个 ClusterRoleBinding，分别授予 group system:bootstrappers 和 groupsystem:nodes 进行 approve client、renew client、renew server 证书的权限（servercsr 是手动 approve 的，见后文）：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/work</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">csr-crb.yaml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="comment"># Approve all CSRs for the group "system:bootstrappers"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">auto-approve-csrs-for-group</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">system:bootstrappers</span></span><br><span class="line"><span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:nodecl</span></span><br><span class="line"><span class="string">ient</span></span><br><span class="line"><span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># To let a node of the group "system:nodes" renew its own credential</span></span><br><span class="line"><span class="string">s</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">node-client-cert-renewal</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">system:nodes</span></span><br><span class="line">	<span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">	<span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span></span><br><span class="line">	<span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">approve-node-server-renewal-csr</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["certificates.k8s.io"]</span></span><br><span class="line">	<span class="attr">resources:</span> <span class="string">["certificatesigningrequests/selfnodeserver"]</span></span><br><span class="line">	<span class="attr">verbs:</span> <span class="string">["create"]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># To let a node of the group "system:nodes" renew its own server credentials</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">node-server-cert-renewal</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">system:nodes</span></span><br><span class="line">	<span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">approve-node-server-renewal-csr</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">csr-crb.yaml</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>auto-approve-csrs-for-group：自动 approve node 的第一次 CSR； 注意第一次CSR 时，请求的 Group 为 system:bootstrappers；</strong></li>
<li><strong>node-client-cert-renewal：自动 approve node 后续过期的 client 证书，自动生成的证书 Group 为 system:nodes;</strong></li>
<li><strong>node-server-cert-renewal：自动 approve node 后续过期的 server 证书，自动生成的证书 Group 为 system:nodes;</strong></li>
</ul>
<h3 id="启动-kubelet-服务"><a href="#启动-kubelet-服务" class="headerlink" title="启动 kubelet 服务"></a>启动 kubelet 服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kubelet/kubelet-plugins/volume/exec/"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"/usr/sbin/swapoff -a"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>启动服务前必须先创建工作目录；</strong></p>
</li>
<li><p><strong>关闭 swap 分区，否则 kubelet 会启动失败；</strong></p>
</li>
</ul>
<p><strong>kubelet 启动后使用 –bootstrap-kubeconfig 向 kube-apiserver 发送 CSR 请求，当这个CSR 被 approve 后，kube-controller-manager 为 kubelet 创建 TLS 客户端证书、私钥和 –kubeletconfig 文件。</strong></p>
<p><strong>注意：kube-controller-manager 需要配置  –cluster-signing-cert-file  和  –cluster-signing-key-file  参数，才会为 TLS Bootstrap 创建证书和私钥。</strong></p>
<h3 id="查看-kubelet-情况"><a href="#查看-kubelet-情况" class="headerlink" title="查看 kubelet 情况"></a>查看 kubelet 情况</h3><p>稍等一会，三个节点的 CSR 都被自动 approved：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get csr</span><br><span class="line">NAME AGE REQUESTOR CONDITION</span><br><span class="line">csr-5rwzm 43s system:node:zhangjun-k8s-01 Pending</span><br><span class="line">csr-65nms 55s system:bootstrap:2sb8wy Approved,Issued</span><br><span class="line">csr-8t5hj 42s system:node:zhangjun-k8s-02 Pending</span><br><span class="line">csr-jkhhs 41s system:node:zhangjun-k8s-03 Pending</span><br><span class="line">csr-jv7dn 56s system:bootstrap:ta7onm Approved,Issued</span><br><span class="line">csr-vb6p5 54s system:bootstrap:xk27zp Approved,Issued</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Pending 的 CSR 用于创建 kubelet server 证书，需要手动 approve，参考后文。</strong></li>
</ul>
<p>所有节点均注册（NotReady 状态是预期的，后续安装了网络插件后就好）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node</span><br><span class="line">NAME STATUS ROLES AGE VERSION</span><br><span class="line">zhangjun-k8s-01 NotReady &lt;none&gt; 10h v1.16.6</span><br><span class="line">zhangjun-k8s-02 NotReady &lt;none&gt; 10h v1.16.6</span><br><span class="line">zhangjun-k8s-03 NotReady &lt;none&gt; 10h v1.16.6</span><br></pre></td></tr></table></figure>

<p>kube-controller-manager 为各 node 生成了 kubeconfig 文件和公私钥：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l /etc/kubernetes/kubelet.kubeconfig</span><br><span class="line">-rw------- 1 root root 2246 Feb 7 15:38 /etc/kubernetes/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">$ ls -l /etc/kubernetes/cert/kubelet-client-*</span><br><span class="line">-rw------- 1 root root 1281 Feb 7 15:38 /etc/kubernetes/cert/kubelet-client-2020-02-07-15-38-21.pem</span><br><span class="line">lrwxrwxrwx 1 root root 59 Feb 7 15:38 /etc/kubernetes/cert/kubelet-client-current.pem -&gt; /etc/kubernetes/cert/kubelet-client-2020-02-07-15-38-21.pem</span><br></pre></td></tr></table></figure>

<p>没有自动生成 kubelet server 证书；</p>
<h3 id="手动-approve-server-cert-csr"><a href="#手动-approve-server-cert-csr" class="headerlink" title="手动 approve server cert csr"></a>手动 approve server cert csr</h3><p>基于安全性考虑，CSR approving controllers 不会自动 approve kubelet server 证书签名请求，需要手动 approve：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get csr</span><br><span class="line">NAME AGE REQUESTOR CONDITION</span><br><span class="line">csr-5rwzm 3m22s system:node:zhangjun-k8s-01 Pending</span><br><span class="line">csr-65nms 3m34s system:bootstrap:2sb8wy Approved,Issued</span><br><span class="line">csr-8t5hj 3m21s system:node:zhangjun-k8s-02 Pending</span><br><span class="line">csr-jkhhs 3m20s system:node:zhangjun-k8s-03 Pending</span><br><span class="line">csr-jv7dn 3m35s system:bootstrap:ta7onm Approved,Issued</span><br><span class="line">csr-vb6p5 3m33s system:bootstrap:xk27zp Approved,Issued</span><br><span class="line">$ <span class="comment"># 手动 approve</span></span><br><span class="line">$ kubectl get csr | grep Pending | awk <span class="string">'&#123;print $1&#125;'</span> | xargs kubectl certificate approve</span><br><span class="line">$ <span class="comment"># 自动生成了 server 证书</span></span><br><span class="line">$ ls -l /etc/kubernetes/cert/kubelet-*</span><br><span class="line">-rw------- 1 root root 1281 Feb 7 15:38 /etc/kubernetes/cert/kubelet-client-2020-02-07-15-38-21.pem</span><br><span class="line">lrwxrwxrwx 1 root root 59 Feb 7 15:38 /etc/kubernetes/cert/kubelet-client-current.pem -&gt; /etc/kubernetes/cert/kubelet-client-2020-02-07-15-38-21.pem</span><br><span class="line">-rw------- 1 root root 1330 Feb 7 15:42 /etc/kubernetes/cert/kubelet-server-2020-02-07-15-42-12.pem</span><br><span class="line">lrwxrwxrwx 1 root root 59 Feb 7 15:42 /etc/kubernetes/cert/kubelet-server-current.pem -&gt; /etc/kubernetes/cert/kubelet-server-2020-02-07-15-42-12.pem</span><br></pre></td></tr></table></figure>

<h3 id="kubelet-api-认证和授权"><a href="#kubelet-api-认证和授权" class="headerlink" title="kubelet api 认证和授权"></a>kubelet api 认证和授权</h3><p>kubelet 配置了如下认证参数：</p>
<ul>
<li><p>authentication.anonymous.enabled：设置为 false，不允许匿名访问 10250 端口；</p>
</li>
<li><p>authentication.x509.clientCAFile：指定签名客户端证书的 CA 证书，开启 HTTPs证书认证；</p>
</li>
<li><p>authentication.webhook.enabled=true：开启 HTTPs bearer token 认证；</p>
<p>同时配置了如下授权参数：</p>
</li>
<li><p>authroization.mode=Webhook：开启 RBAC 授权；</p>
</li>
</ul>
<p>kubelet 收到请求后，使用 clientCAFile 对证书签名进行认证，或者查询 bearer token是否有效。如果两者都没通过，则拒绝请求，提示  Unauthorized  ：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s --cacert /etc/kubernetes/cert/ca.pem https://172.27.138.251:10250/metrics</span><br><span class="line">Unauthorized</span><br><span class="line">$ curl -s --cacert /etc/kubernetes/cert/ca.pem -H <span class="string">"Authorization: Bearer 123456"</span> https://172.27.138.251:10250/metrics</span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure>

<h4 id="证书认证和授权"><a href="#证书认证和授权" class="headerlink" title="证书认证和授权"></a>证书认证和授权</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="comment"># 权限不足的证书；</span></span><br><span class="line">$ curl -s --cacert /etc/kubernetes/cert/ca.pem --cert /etc/kubernetes/cert/kube-controller-manager.pem --key /etc/kubernetes/cert/kube-controller-manager-key.pem https://172.27.138.251:10250/metrics</span><br><span class="line">Forbidden (user=system:kube-controller-manager, verb=get, resource=nodes, subresource=metrics)</span><br><span class="line">$ <span class="comment"># 使用部署 kubectl 命令行工具时创建的、具有最高权限的 admin 证书；</span></span><br><span class="line">$ curl -s --cacert /etc/kubernetes/cert/ca.pem --cert /opt/k8s/work/a</span><br><span class="line">dmin.pem --key /opt/k8s/work/admin-key.pem https://172.27.138.251:102</span><br><span class="line">50/metrics|head</span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generatedand sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure>

<ul>
<li>–cacert  、 –cert  、 –key  的参数值必须是文件路径，如上面的./admin.pem  不能省略  ./  ，否则返回  401 Unauthorized  ；</li>
</ul>
<h3 id="bear-token-认证和授权"><a href="#bear-token-认证和授权" class="headerlink" title="bear token 认证和授权"></a>bear token 认证和授权</h3><p>创建一个 ServiceAccount，将它和 ClusterRole system:kubelet-api-admin 绑定，从而具有调用 kubelet API 的权限：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create sa kubelet-api-test</span><br><span class="line">kubectl create clusterrolebinding kubelet-api-test --clusterrole=system:kubelet-api-admin --serviceaccount=default:kubelet-api-test</span><br><span class="line">SECRET=$(kubectl get secrets | grep kubelet-api-test | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">TOKEN=$(kubectl describe secret <span class="variable">$&#123;SECRET&#125;</span> | grep -E <span class="string">'^token'</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s --cacert /etc/kubernetes/cert/ca.pem -H <span class="string">"Authorization: Bearer <span class="variable">$&#123;TOKEN&#125;</span>"</span> https://172.27.138.251:10250/metrics | head</span><br><span class="line"><span class="comment"># HELP apiserver_audit_event_total Counter of audit events generatedand sent to the audit backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_event_total counter</span></span><br><span class="line">apiserver_audit_event_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_audit_requests_rejected_total Counter of apiserver requests rejected due to an error in audit logging backend.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_audit_requests_rejected_total counter</span></span><br><span class="line">apiserver_audit_requests_rejected_total 0</span><br><span class="line"><span class="comment"># HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.</span></span><br><span class="line"><span class="comment"># TYPE apiserver_client_certificate_expiration_seconds histogram</span></span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"0"</span>&#125; 0</span><br><span class="line">apiserver_client_certificate_expiration_seconds_bucket&#123;le=<span class="string">"1800"</span>&#125; 0</span><br></pre></td></tr></table></figure>

<h3 id="cadvisor-和-metrics"><a href="#cadvisor-和-metrics" class="headerlink" title="cadvisor 和 metrics"></a>cadvisor 和 metrics</h3><p>cadvisor 是内嵌在 kubelet 二进制中的，统计所在节点各容器的资源(CPU、内存、磁盘、网卡)使用情况的服务。</p>
<p>浏览器访问 <a href="https://172.27.138.251:10250/metrics" target="_blank" rel="noopener">https://172.27.138.251:10250/metrics</a> 和<a href="https://172.27.138.251:10250/metrics/cadvisor" target="_blank" rel="noopener">https://172.27.138.251:10250/metrics/cadvisor</a> 分别返回 kubelet 和 cadvisor 的metrics。</p>
<p>注意：</p>
<p>kubelet.config.json 设置 authentication.anonymous.enabled 为 false，不允许匿名证书访问 10250 的 https 服务；<br>参考 浏览器访问kube-apiserver安全端口，创建和导入相关证书，然后访问上面的 10250 端口；</p>
<h3 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h3><ol>
<li>kubelet 认证和授权：<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/</a></li>
</ol>
<h2 id="部署-kube-proxy-组件"><a href="#部署-kube-proxy-组件" class="headerlink" title="部署 kube-proxy 组件"></a>部署 kube-proxy 组件</h2><p>kube-proxy 运行在所有 worker 节点上，它监听 apiserver 中 service 和 endpoint 的变化情况，创建路由规则以提供服务 IP 和负载均衡功能。</p>
<p>本文档讲解部署 ipvs 模式的 kube-proxy 过程。</p>
<p>注意：如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s-01 节点上执行，然后远程分发文件和执行命令。</p>
<h3 id="下载和分发-kube-proxy-二进制文件"><a href="#下载和分发-kube-proxy-二进制文件" class="headerlink" title="下载和分发 kube-proxy 二进制文件"></a>下载和分发 kube-proxy 二进制文件</h3><p>参考 05-1.部署master节点.md。</p>
<h3 id="创建-kube-proxy-证书"><a href="#创建-kube-proxy-证书" class="headerlink" title="创建 kube-proxy 证书"></a>创建 kube-proxy 证书</h3><p>创建证书签名请求：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF &#123;</span><br><span class="line">	"CN": "system:kube-proxy",</span><br><span class="line">	"key": &#123;</span><br><span class="line">		"algo": "rsa",</span><br><span class="line">		"size": 2048</span><br><span class="line">	&#125;,</span><br><span class="line">	"names": [&#123;</span><br><span class="line">		"C": "CN",</span><br><span class="line">		"ST": "BeiJing",</span><br><span class="line">		"L": "BeiJing",</span><br><span class="line">		"O": "k8s",</span><br><span class="line">		"OU": "opsnull"</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>CN：指定该证书的 User 为  system:kube-proxy  ；</li>
<li>预定义的 RoleBinding  system:node-proxier  将User  system:kube-proxy  与Role  system:node-proxier  绑定，该 Role 授予了调用  kube-apiserverProxy 相关 API 的权限；</li>
<li>该证书只会被 kube-proxy 当做 client 证书使用，所以 hosts 字段为空；</li>
</ul>
<p>生成证书和私钥：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">cfssl gencert -ca=/opt/k8s/work/ca.pem \</span><br><span class="line">-ca-key=/opt/k8s/work/ca-key.pem \</span><br><span class="line">-config=/opt/k8s/work/ca-config.json \</span><br><span class="line">-profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">ls kube-proxy*</span><br></pre></td></tr></table></figure>

<h3 id="创建和分发-kubeconfig-文件-2"><a href="#创建和分发-kubeconfig-文件-2" class="headerlink" title="创建和分发 kubeconfig 文件"></a>创建和分发 kubeconfig 文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">--certificate-authority=/opt/k8s/work/ca.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">--kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy \</span><br><span class="line">--client-certificate=kube-proxy.pem \</span><br><span class="line">--client-key=kube-proxy-key.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=kube-proxy \</span><br><span class="line">--kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>分发 kubeconfig 文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">scp kube-proxy.kubeconfig root@<span class="variable">$&#123;node_name&#125;</span>:/etc/kubernetes/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建-kube-proxy-配置文件"><a href="#创建-kube-proxy-配置文件" class="headerlink" title="创建 kube-proxy 配置文件"></a>创建 kube-proxy 配置文件</h3><p>从 v1.10 开始，kube-proxy 部分参数可以配置文件中配置。可以使用  –write-config-to  选项生成该配置文件，或者参考 源代码的注释。</p>
<p>创建 kube-proxy config 文件模板：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kube-proxy-config.yaml.template &lt;&lt;EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: <span class="string">"/etc/kubernetes/kube-proxy.kubeconfig"</span></span><br><span class="line">  qps: 100</span><br><span class="line">bindAddress: <span class="comment">##NODE_IP##</span></span><br><span class="line">healthzBindAddress: <span class="comment">##NODE_IP##:10256</span></span><br><span class="line">metricsBindAddress: <span class="comment">##NODE_IP##:10249</span></span><br><span class="line">enableProfiling: <span class="literal">true</span></span><br><span class="line">clusterCIDR: <span class="variable">$&#123;CLUSTER_CIDR&#125;</span></span><br><span class="line">hostnameOverride: <span class="comment">##NODE_NAME##</span></span><br><span class="line">mode: <span class="string">"ipvs"</span></span><br><span class="line">portRange: <span class="string">""</span></span><br><span class="line">iptables:</span><br><span class="line">	masqueradeAll: <span class="literal">false</span></span><br><span class="line">ipvs:</span><br><span class="line">	scheduler: rr</span><br><span class="line">	excludeCIDRs: []</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>bindAddress  : 监听地址；</li>
<li>clientConnection.kubeconfig  : 连接 apiserver 的 kubeconfig 文件；</li>
<li>clusterCIDR  : kube-proxy 根据  –cluster-cidr  判断集群内部和外部流量，指定  –cluster-cidr  或  –masquerade-all  选项后 kube-proxy 才会对访问Service IP 的请求做 SNAT；</li>
<li>hostnameOverride  : 参数值必须与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 ipvs 规则；</li>
<li>mode  : 使用 ipvs 模式；</li>
</ul>
<p>为各节点创建和分发 kube-proxy 配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> (( i=0; i &lt; 3; i++ ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;NODE_NAMES[i]&#125;</span>"</span></span><br><span class="line">sed -e <span class="string">"s/##NODE_NAME##/<span class="variable">$&#123;NODE_NAMES[i]&#125;</span>/"</span> -e <span class="string">"s/##NODE_IP##/<span class="variable">$&#123;NODE_IPS[i]&#125;</span>/"</span> kube-proxy-config.yaml.template &gt; kube-proxy-config-<span class="variable">$&#123;NODE_NAMES[i]&#125;</span>.yaml.template</span><br><span class="line">scp kube-proxy-config-<span class="variable">$&#123;NODE_NAMES[i]&#125;</span>.yaml.template root@<span class="variable">$&#123;NODE_NAMES[i]&#125;</span>:/etc/kubernetes/kube-proxy-config.yaml</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="创建和分发-kube-proxy-systemd-unit-文件"><a href="#创建和分发-kube-proxy-systemd-unit-文件" class="headerlink" title="创建和分发 kube-proxy systemd unit 文件"></a>创建和分发 kube-proxy systemd unit 文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kube-proxy.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy</span><br><span class="line">ExecStart=/opt/k8s/bin/kube-proxy \\</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy-config.yaml \\</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>分发 kube-proxy systemd unit 文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_name <span class="keyword">in</span> <span class="variable">$&#123;NODE_NAMES[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_name&#125;</span>"</span></span><br><span class="line">scp kube-proxy.service root@<span class="variable">$&#123;node_name&#125;</span>:/etc/systemd/system/</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="启动-kube-proxy-服务"><a href="#启动-kube-proxy-服务" class="headerlink" title="启动 kube-proxy 服务"></a>启动 kube-proxy 服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"mkdir -p <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"modprobe ip_vs_rr"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="检查启动结果-1"><a href="#检查启动结果-1" class="headerlink" title="检查启动结果"></a>检查启动结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"systemctl status kube-proxy|grep Active"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>确保状态为  active (running)  ，否则查看日志，确认原因：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="查看监听端口"><a href="#查看监听端口" class="headerlink" title="查看监听端口"></a>查看监听端口</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo netstat -lnpt|grep kube-prox</span><br><span class="line">tcp 0 0 172.27.138.251:10256 0.0.0.0:* LISTEN 30590/kube-proxy</span><br><span class="line">tcp 0 0 172.27.138.251:10249 0.0.0.0:* LISTEN 30590/kube-proxy</span><br></pre></td></tr></table></figure>

<ul>
<li>10249：http prometheus metrics port;</li>
<li>10256：http healthz port;</li>
</ul>
<p>查看 ipvs 路由规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh root@<span class="variable">$&#123;node_ip&#125;</span> <span class="string">"/usr/sbin/ipvsadm -ln"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>预期输出：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 172.27.138.251</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 10.254.0.1:443 rr</span><br><span class="line">-&gt; 172.27.137.229:6443 Masq 1 0 0</span><br><span class="line">-&gt; 172.27.138.239:6443 Masq 1 0 0</span><br><span class="line">-&gt; 172.27.138.251:6443 Masq 1 0 0</span><br><span class="line">&gt;&gt;&gt; 172.27.137.229</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 10.254.0.1:443 rr</span><br><span class="line">-&gt; 172.27.137.229:6443 Masq 1 0 0</span><br><span class="line">-&gt; 172.27.138.239:6443 Masq 1 0 0</span><br><span class="line">-&gt; 172.27.138.251:6443 Masq 1 0 0</span><br><span class="line">&gt;&gt;&gt; 172.27.138.239</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 10.254.0.1:443 rr</span><br><span class="line">-&gt; 172.27.137.229:6443 Masq 1 0 0</span><br><span class="line">-&gt; 172.27.138.239:6443 Masq 1 0 0</span><br><span class="line">-&gt; 172.27.138.251:6443 Masq 1 0 0</span><br></pre></td></tr></table></figure>

<p>可见所有通过 https 访问 K8S SVC kubernetes 的请求都转发到 kube-apiserver 节点的6443 端口；</p>
<h2 id="部署-calico-网络"><a href="#部署-calico-网络" class="headerlink" title="部署 calico 网络"></a>部署 calico 网络</h2><p>kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通。</p>
<p>calico 使用 IPIP 或 BGP 技术（默认为 IPIP）为各节点创建一个可以互通的 Pod 网络。</p>
<p>如果使用 flannel，请参考附件 E.部署flannel网络.md（flannel 与 docker 结合使用）</p>
<p>注意：如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s01 节点上执行。</p>
<h3 id="安装-calico-网络插件"><a href="#安装-calico-网络插件" class="headerlink" title="安装 calico 网络插件"></a>安装 calico 网络插件</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/opt/</span>k8s/work</span><br><span class="line">curl <span class="string">https:</span><span class="comment">//docs.projectcalico.org/manifests/calico.yaml -O</span></span><br></pre></td></tr></table></figure>

<p>修改配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cp</span> <span class="string">calico.yaml</span> <span class="string">calico.yaml.orig</span></span><br><span class="line"><span class="string">$</span> <span class="string">diff</span> <span class="string">calico.yaml.orig</span> <span class="string">calico.yaml</span></span><br><span class="line"><span class="string">630c630,632</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">value:</span> <span class="string">"192.168.0.0/16"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">&gt;</span> <span class="attr">value:</span> <span class="string">"172.30.0.0/16"</span></span><br><span class="line"><span class="string">&gt;</span> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IP_AUTODETECTION_METHOD</span></span><br><span class="line"><span class="string">&gt;</span> <span class="attr">value:</span> <span class="string">"interface=eth.*"</span></span><br><span class="line"><span class="string">699c701</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">path:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">&gt;</span> <span class="attr">path:</span> <span class="string">/opt/k8s/bin</span></span><br></pre></td></tr></table></figure>

<p>将 Pod 网段地址修改为  172.30.0.0/16  ;<br>calico 自动探查互联网卡，如果有多快网卡，则可以配置用于互联的网络接口命名正则表达式，如上面的  eth.*  (根据自己服务器的网络接口名修改)；</p>
<p>运行 calico 插件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>calico 插架以 daemonset 方式运行在所有的 K8S 节点上。</li>
</ul>
<p>查看 calico 运行状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINE SS GATES</span><br><span class="line">calico-kube-controllers-77c4b7448-99lfq 1/1 Running 0 2m11s 172.30.184.128 </span><br><span class="line">zhangjun-k8s-03 &lt;none&gt; &lt;none&gt;calico-node-dxnjs 1/1 Running 0</span><br><span class="line">2m11s 172.27.137.229 zhangjun-k8s-02 &lt;none&gt; &lt;none&gt;calico-node-rknzz 1/1 Running 0</span><br><span class="line">2m11s 172.27.138.239 zhangjun-k8s-03 &lt;none&gt; &lt;none&gt;calico-node-rw84c 1/1 Running 0</span><br><span class="line">2m11s 172.27.138.251 zhangjun-k8s-01 &lt;none&gt; &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>使用 crictl 命令查看 calico 使用的镜像：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ crictl images</span><br><span class="line">IMAGE TAGIMAGE ID SIZE</span><br><span class="line">docker.io/calico/cni v3<span class="number">.12</span><span class="number">.0</span> cb6799752c46c <span class="number">66.5</span>MB</span><br><span class="line">docker.io/calico/node v3<span class="number">.12</span><span class="number">.0</span> fc05bc4225f39 <span class="number">89.7</span>MB</span><br><span class="line">docker.io/calico/pod2daemon-flexvol v3<span class="number">.12</span><span class="number">.0</span> <span class="number">98793</span>d0a88c82 <span class="number">37.5</span>MB</span><br><span class="line">registry.cn-beijing.aliyuncs.com/images_k8s/pause-amd64 <span class="number">3.121</span>a595adc69ca <span class="number">326</span>kB</span><br></pre></td></tr></table></figure>

<ul>
<li>如果 crictl 输出为空或执行失败，则有可能是缺少配置文件  /etc/crictl.yaml导致的，该文件的配置如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/crictl.yaml</span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h1 id="验证集群功能"><a href="#验证集群功能" class="headerlink" title="验证集群功能"></a>验证集群功能</h1><p>本文档验证 K8S 集群是否工作正常。</p>
<p>注意：如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s-01 节点上执行，然后远程分发文件和执行命令。</p>
<h2 id="检查节点状态"><a href="#检查节点状态" class="headerlink" title="检查节点状态"></a>检查节点状态</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME STATUS ROLES AGE VERSION</span><br><span class="line">zhangjun-k8s-01 Ready &lt;none&gt; 15m v1.16.6</span><br><span class="line">zhangjun-k8s-02 Ready &lt;none&gt; 15m v1.16.6</span><br><span class="line">zhangjun-k8s-03 Ready &lt;none&gt; 15m v1.16.6</span><br></pre></td></tr></table></figure>

<p>都为 Ready 且版本为 v1.16.6 时正常。</p>
<h2 id="创建测试文件"><a href="#创建测试文件" class="headerlink" title="创建测试文件"></a>创建测试文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/work</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">nginx-ds.yml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">nginx-ds</span></span><br><span class="line">	<span class="attr">labels:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">nginx-ds</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">nginx-ds</span></span><br><span class="line">	<span class="attr">ports:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">		<span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">		<span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">nginx-ds</span></span><br><span class="line">	<span class="attr">labels:</span></span><br><span class="line">		<span class="attr">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">matchLabels:</span></span><br><span class="line">			<span class="attr">app:</span> <span class="string">nginx-ds</span></span><br><span class="line">	<span class="attr">template:</span></span><br><span class="line">		<span class="attr">metadata:</span></span><br><span class="line">			<span class="attr">labels:</span></span><br><span class="line">				<span class="attr">app:</span> <span class="string">nginx-ds</span></span><br><span class="line">	<span class="attr">spec:</span></span><br><span class="line">		<span class="attr">containers:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">			<span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">			<span class="attr">ports:</span></span><br><span class="line">			<span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h3 id="执行测试"><a href="#执行测试" class="headerlink" title="执行测试"></a>执行测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx-ds.yml</span><br></pre></td></tr></table></figure>

<p>检查各节点的 Pod IP 连通性</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -o wide -l app=nginx-ds</span><br><span class="line">NAME READY STATUS RESTARTS AGE IPNODE NOMINATED NODE READINESS GATES</span><br><span class="line">nginx-ds-j7v5g 1/1 Running 0 61s 172.30.244.1zhangjun-k8s-01 &lt;none&gt; &lt;none&gt;</span><br><span class="line">nginx-ds-js8g8 1/1 Running 0 61s 172.30.82.129 zhangjun-k8s-02 &lt;none&gt; &lt;none&gt;</span><br><span class="line">nginx-ds-n2p4x 1/1 Running 0 61s 172.30.184.130  zhangjun-k8s-03 &lt;none&gt; &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>在所有 Node 上分别 ping 上面三个 Pod IP，看是否连通：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"ping -c 1 172.30.244.1"</span></span><br><span class="line">ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"ping -c 1 172.30.82.129"</span></span><br><span class="line">ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"ping -c 1 172.30.184.130"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="检查服务-IP-和端口可达性"><a href="#检查服务-IP-和端口可达性" class="headerlink" title="检查服务 IP 和端口可达性"></a>检查服务 IP 和端口可达性</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -l app=nginx-ds</span><br><span class="line">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span><br><span class="line">nginx-ds NodePort 10.254.116.22 &lt;none&gt; 80:30562/TCP 2m7s</span><br></pre></td></tr></table></figure>

<p>可见：</p>
<ul>
<li>Service Cluster IP：10.254.116.22</li>
<li>服务端口：80</li>
<li>NodePort 端口：30562</li>
</ul>
<p>在所有 Node 上 curl Service IP：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"curl -s 10.254.116.22"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>预期输出 nginx 欢迎页面内容。</p>
<h2 id="检查服务的-NodePort-可达性"><a href="#检查服务的-NodePort-可达性" class="headerlink" title="检查服务的 NodePort 可达性"></a>检查服务的 NodePort 可达性</h2><p>在所有 Node 上执行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="keyword">for</span> node_ip <span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;node_ip&#125;</span>"</span></span><br><span class="line">ssh <span class="variable">$&#123;node_ip&#125;</span> <span class="string">"curl -s <span class="variable">$&#123;node_ip&#125;</span>:30562"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>预期输出 nginx 欢迎页面内容。</p>
<h1 id="部署集群插件"><a href="#部署集群插件" class="headerlink" title="部署集群插件"></a>部署集群插件</h1><p>插件是集群的附件组件，丰富和完善了集群的功能。</p>
<h2 id="部署-coredns-插件"><a href="#部署-coredns-插件" class="headerlink" title="部署 coredns 插件"></a>部署 coredns 插件</h2><p>如果没有特殊指明，本文档的所有操作均在 k8s-01 节点上执行；</p>
<h3 id="下载和配置-coredns"><a href="#下载和配置-coredns" class="headerlink" title="下载和配置 coredns"></a>下载和配置 coredns</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/coredns/deployment.git</span><br><span class="line">mv deployment coredns-deployment</span><br></pre></td></tr></table></figure>

<h3 id="创建-coredns"><a href="#创建-coredns" class="headerlink" title="创建 coredns"></a>创建 coredns</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work/coredns-deployment/kubernetes</span><br><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line">./deploy.sh -i <span class="variable">$&#123;CLUSTER_DNS_SVC_IP&#125;</span> -d <span class="variable">$&#123;CLUSTER_DNS_DOMAIN&#125;</span> | kubectl apply -f -</span><br></pre></td></tr></table></figure>

<h3 id="检查-coredns-功能"><a href="#检查-coredns-功能" class="headerlink" title="检查 coredns 功能"></a>检查 coredns 功能</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all -n kube-system -l k8s-app=kube-dns</span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">pod/coredns-76b74f549-cwm8d 1/1 Running 0 62s</span><br><span class="line">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S)</span><br><span class="line">AGE</span><br><span class="line">service/kube-dns ClusterIP 10.254.0.2 &lt;none&gt; 53/UDP,53/T</span><br><span class="line">CP,9153/TCP 62s</span><br><span class="line">NAME READY UP-TO-DATE AVAILABLE AGE</span><br><span class="line">deployment.apps/coredns 1/1 1 1 62s</span><br><span class="line">NAME DESIRED CURRENT READY AGE</span><br><span class="line">replicaset.apps/coredns-76b74f549 1 1 1 62s</span><br></pre></td></tr></table></figure>

<h4 id="新建一个-Deployment："><a href="#新建一个-Deployment：" class="headerlink" title="新建一个 Deployment："></a>新建一个 Deployment：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/work</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">my-nginx.yaml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">matchLabels:</span></span><br><span class="line">			<span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">	<span class="attr">template:</span></span><br><span class="line">		<span class="attr">metadata:</span></span><br><span class="line">			<span class="attr">labels:</span></span><br><span class="line">				<span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">		<span class="attr">spec:</span></span><br><span class="line">			<span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">      	<span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">      	<span class="attr">ports:</span></span><br><span class="line">      	<span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">my-nginx.yaml</span></span><br></pre></td></tr></table></figure>

<p>export 该 Deployment, 生成  my-nginx  服务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose deploy my-nginx</span><br><span class="line">service <span class="string">"my-nginx"</span> exposed</span><br><span class="line">$ kubectl get services my-nginx -o wide</span><br><span class="line">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGESELECTOR</span><br><span class="line">my-nginx ClusterIP 10.254.67.218 &lt;none&gt; 80/TCP 5s run=my-nginx</span><br></pre></td></tr></table></figure>

<p>创建另一个 Pod，查看  /etc/resolv.conf  是否包含  kubelet  配置的  –cluster-dns  和  –cluster-domain  ，是否能够将服务  my-nginx  解析到上面显示的 Cluster IP  10.254.40.167</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cd</span> <span class="string">/opt/k8s/work</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">dnsutils-ds.yml</span> <span class="string">&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">dnsutils-ds</span></span><br><span class="line">		<span class="attr">labels:</span></span><br><span class="line">			<span class="attr">app:</span> <span class="string">dnsutils-ds</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">dnsutils-ds</span></span><br><span class="line">	<span class="attr">ports:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">		<span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">		<span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">dnsutils-ds</span></span><br><span class="line">	<span class="attr">labels:</span></span><br><span class="line">		<span class="attr">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">	<span class="attr">selector:</span></span><br><span class="line">		<span class="attr">matchLabels:</span></span><br><span class="line">			<span class="attr">app:</span> <span class="string">dnsutils-ds</span></span><br><span class="line">	<span class="attr">template:</span></span><br><span class="line">		<span class="attr">metadata:</span></span><br><span class="line">			<span class="attr">labels:</span></span><br><span class="line">				<span class="attr">app:</span> <span class="string">dnsutils-ds</span></span><br><span class="line">		<span class="attr">spec:</span></span><br><span class="line">			<span class="attr">containers:</span></span><br><span class="line">			<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-dnsutils</span></span><br><span class="line">				<span class="attr">image:</span> <span class="string">tutum/dnsutils:latest</span></span><br><span class="line">				<span class="attr">command:</span></span><br><span class="line">					<span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">					<span class="bullet">-</span> <span class="string">"3600"</span></span><br><span class="line">				<span class="attr">ports:</span></span><br><span class="line">				<span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">dnsutils-ds.yml</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -lapp=dnsutils-ds -o wide</span><br><span class="line">NAME READY STATUS RESTARTS AGE IPNODE NOMINATED NODE READINESS GATES</span><br><span class="line">dnsutils-ds-7h9np 1/1 Running 0 69s 172.30.244.3</span><br><span class="line">zhangjun-k8s-01 &lt;none&gt; &lt;none&gt;</span><br><span class="line">dnsutils-ds-fthdl 1/1 Running 0 69s 172.30.82.131</span><br><span class="line">zhangjun-k8s-02 &lt;none&gt; &lt;none&gt;</span><br><span class="line">dnsutils-ds-w69zp 1/1 Running 0 69s 172.30.184.132</span><br><span class="line">zhangjun-k8s-03 &lt;none&gt; &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -it <span class="built_in">exec</span> dnsutils-ds-7h9np cat /etc/resolv.conf</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local 4pd.io</span><br><span class="line">nameserver 10.254.0.2</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -it <span class="built_in">exec</span> dnsutils-ds-7h9np nslookup kubernetes</span><br><span class="line">Server: 10.254.0.2</span><br><span class="line">Address: 10.254.0.2<span class="comment">#53</span></span><br><span class="line">Name: kubernetes.default.svc.cluster.local</span><br><span class="line">Address: 10.254.0.1</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -it <span class="built_in">exec</span> dnsutils-ds-7h9np nslookup www.baidu.com</span><br><span class="line">Server: 10.254.0.2</span><br><span class="line">Address: 10.254.0.2<span class="comment">#53</span></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">*** Can<span class="string">'t find www.baidu.com: No answer</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-it</span> <span class="string">exec</span> <span class="string">dnsutils-ds-7h9np</span> <span class="string">nslookup</span> <span class="string">www.baidu.com.</span></span><br><span class="line"><span class="attr">Server:</span> <span class="number">10.254</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line"><span class="attr">Address:</span> <span class="number">10.254</span><span class="number">.0</span><span class="number">.2</span><span class="comment">#53</span></span><br><span class="line"><span class="attr">Non-authoritative answer:</span></span><br><span class="line"><span class="string">www.baidu.com</span> <span class="string">canonical</span> <span class="string">name</span> <span class="string">=</span> <span class="string">www.a.shifen.com.</span></span><br><span class="line"><span class="attr">Name:</span> <span class="string">www.a.shifen.com</span></span><br><span class="line"><span class="attr">Address:</span> <span class="number">220.181</span><span class="number">.38</span><span class="number">.150</span></span><br><span class="line"><span class="attr">Name:</span> <span class="string">www.a.shifen.com</span></span><br><span class="line"><span class="attr">Address:</span> <span class="number">220.181</span><span class="number">.38</span><span class="number">.149</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-it</span> <span class="string">exec</span> <span class="string">dnsutils-ds-7h9np</span> <span class="string">nslookup</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">Server:</span> <span class="number">10.254</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line"><span class="attr">Address:</span> <span class="number">10.254</span><span class="number">.0</span><span class="number">.2</span><span class="comment">#53</span></span><br><span class="line"><span class="attr">Name:</span> <span class="string">my-nginx.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">Address:</span> <span class="number">10.254</span><span class="number">.67</span><span class="number">.218</span></span><br></pre></td></tr></table></figure>

<h3 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://community.infoblox.com/t5/Community-Blog/CoreDNS-for-Kubernetes-Service-Discovery/ba-p/8187" target="_blank" rel="noopener">https://community.infoblox.com/t5/Community-Blog/CoreDNS-for-Kubernetes-Service-Discovery/ba-p/8187</a></li>
<li><a href="https://coredns.io/2017/03/01/coredns-for-kubernetes-service-discovery-take-2/" target="_blank" rel="noopener">https://coredns.io/2017/03/01/coredns-for-kubernetes-service-discovery-take-2/</a></li>
<li><a href="https://www.cnblogs.com/boshen-hzb/p/7511432.html" target="_blank" rel="noopener">https://www.cnblogs.com/boshen-hzb/p/7511432.html</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns</a></li>
</ol>
<h2 id="部署-dashboard-插件"><a href="#部署-dashboard-插件" class="headerlink" title="部署 dashboard 插件"></a>部署 dashboard 插件</h2><p>如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s-01 节点上执行；</p>
<h3 id="下载和修改配置文件"><a href="#下载和修改配置文件" class="headerlink" title="下载和修改配置文件"></a>下载和修改配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc4/aio/deploy/recommended.yaml</span><br><span class="line">mv recommended.yaml dashboard-recommended.yaml</span><br></pre></td></tr></table></figure>

<h3 id="执行所有定义文件"><a href="#执行所有定义文件" class="headerlink" title="执行所有定义文件"></a>执行所有定义文件</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="string">/opt/k8s/work</span></span><br><span class="line">kubectl apply -f dashboard-recommended.yaml</span><br></pre></td></tr></table></figure>

<h3 id="查看运行状态"><a href="#查看运行状态" class="headerlink" title="查看运行状态"></a>查看运行状态</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">get</span> pods -n kubernetes-dashboard</span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">dashboard-metrics-scraper<span class="number">-7</span>b8b58dc8b-dlk5t <span class="number">1</span>/<span class="number">1</span> Running <span class="number">070</span>s</span><br><span class="line">kubernetes-dashboard<span class="number">-6</span>cfc8c4c9-j8vcm <span class="number">1</span>/<span class="number">1</span> Running <span class="number">070</span>s</span><br></pre></td></tr></table></figure>

<h3 id="访问-dashboard"><a href="#访问-dashboard" class="headerlink" title="访问 dashboard"></a>访问 dashboard</h3><p>从 1.7 开始，dashboard 只允许通过 https 访问，如果使用 kube proxy 则必须监听localhost 或 127.0.0.1。对于 NodePort 没有这个限制，但是仅建议在开发环境中使用。对于不满足这些条件的登录访问，在登录成功后浏览器不跳转，始终停在登录界面。</p>
<h3 id="通过-port-forward-访问-dashboard"><a href="#通过-port-forward-访问-dashboard" class="headerlink" title="通过 port forward 访问 dashboard"></a>通过 port forward 访问 dashboard</h3><p>启动端口转发：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zhangjun-k8s-01 work] kubectl port-forward -n kubernetes-dashboard svc/kubernetes-dashboard 4443:443 --address 0.0.0.0</span><br></pre></td></tr></table></figure>

<p>浏览器访问 URL： <a href="https://172.27.138.251:4443" target="_blank" rel="noopener">https://172.27.138.251:4443</a></p>
<h3 id="创建登录-Dashboard-的-token-和-kubeconfig-配置文件"><a href="#创建登录-Dashboard-的-token-和-kubeconfig-配置文件" class="headerlink" title="创建登录 Dashboard 的 token 和 kubeconfig 配置文件"></a>创建登录 Dashboard 的 token 和 kubeconfig 配置文件</h3><p>dashboard 默认只支持 token 认证（不支持 client 证书认证），所以如果使用Kubeconfig 文件，需要将 token 写入到该文件。</p>
<h4 id="创建登录-token"><a href="#创建登录-token" class="headerlink" title="创建登录 token"></a>创建登录 token</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create sa dashboard-admin -n kube-system</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin </span><br><span class="line">ADMIN_SECRET=$(kubectl get secrets -n kube-system | grep dashboard-admin | awk <span class="string">'&#123;print $1&#125;'</span>) DASHBOARD_LOGIN_TOKEN=$(kubectl describe secret -n kube-system <span class="variable">$&#123;ADMIN_SECRET&#125;</span> | grep -E <span class="string">'^token'</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;DASHBOARD_LOGIN_TOKEN&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用输出的 token 登录 Dashboard。</p>
<h3 id="创建使用-token-的-KubeConfig-文件"><a href="#创建使用-token-的-KubeConfig-文件" class="headerlink" title="创建使用 token 的 KubeConfig 文件"></a>创建使用 token 的 KubeConfig 文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /opt/k8s/bin/environment.sh</span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">--certificate-authority=/etc/kubernetes/cert/ca.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">--kubeconfig=dashboard.kubeconfig</span><br><span class="line"><span class="comment"># 设置客户端认证参数，使用上面创建的 Token</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials dashboard_user \</span><br><span class="line">--token=<span class="variable">$&#123;DASHBOARD_LOGIN_TOKEN&#125;</span> \</span><br><span class="line">--kubeconfig=dashboard.kubeconfig</span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=dashboard_user \</span><br><span class="line">--kubeconfig=dashboard.kubeconfig</span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=dashboard.kubeconfig</span><br></pre></td></tr></table></figure>

<p>用生成的 dashboard.kubeconfig 登录 Dashboard。</p>
<h3 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://github.com/kubernetes/dashboard/wiki/Access-control" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/wiki/Access-control</a></li>
<li><a href="https://github.com/kubernetes/dashboard/issues/2558" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/issues/2558</a></li>
<li><a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/</a></li>
<li><a href="https://github.com/kubernetes/dashboard/wiki/Accessing-Dashboard---1.7.X-and-above" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/wiki/Accessing-Dashboard---1.7.X-and-above</a></li>
<li><a href="https://github.com/kubernetes/dashboard/issues/2540" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/issues/2540</a></li>
</ol>
<h2 id="部署-kube-prometheus-插架"><a href="#部署-kube-prometheus-插架" class="headerlink" title="部署 kube-prometheus 插架"></a>部署 kube-prometheus 插架</h2><p>kube-prometheus 是一整套监控解决方案，它使用 Prometheus 采集集群指标，Grafana 做展示，包含如下组件：</p>
<ul>
<li>The Prometheus Operator</li>
<li>Highly available Prometheus</li>
<li>Highly available Alertmanager</li>
<li>Prometheus node-exporter</li>
<li>Prometheus Adapter for Kubernetes Metrics APIs （k8s-prometheus-adapter）</li>
<li>kube-state-metrics</li>
<li>Grafana</li>
</ul>
<p>其中 k8s-prometheus-adapter 使用 Prometheus 实现了 metrics.k8s.io 和custom.metrics.k8s.io API，所以不需要再部署  metrics-server  。 如果要单独部署metrics-server  ，请参考：C.metrics-server插件.md</p>
<p>如果没有特殊指明，本文档的所有操作均在 k8s-01 节点上执行；</p>
<h3 id="下载和安装"><a href="#下载和安装" class="headerlink" title="下载和安装"></a>下载和安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/coreos/kube-prometheus.git</span><br><span class="line"><span class="built_in">cd</span> kube-prometheus/</span><br><span class="line">sed -i -e <span class="string">'s_quay.io_quay.azk8s.cn_'</span> manifests/*.yaml manifests/setup/*.yaml <span class="comment"># 使用微软的 Registry</span></span><br><span class="line">kubectl apply -f manifests/setup <span class="comment"># 安装 prometheus-operator</span></span><br><span class="line">kubectl apply -f manifests/ <span class="comment"># 安装 promethes metric adapter</span></span><br></pre></td></tr></table></figure>

<h3 id="查看运行状态-1"><a href="#查看运行状态-1" class="headerlink" title="查看运行状态"></a>查看运行状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n monitoring</span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">alertmanager-main-0 2/2 Running 063s</span><br><span class="line">alertmanager-main-1 2/2 Running 063s</span><br><span class="line">alertmanager-main-2 2/2 Running 063s</span><br><span class="line">grafana-76b8d59b9b-nd6gk 1/1 Running 011m</span><br><span class="line">kube-state-metrics-67b7c5dc78-sktzg 3/3 Running 073s</span><br><span class="line">node-exporter-prsvf 2/2 Running 034s</span><br><span class="line">node-exporter-qdh6n 2/2 Running 071s</span><br><span class="line">node-exporter-z6h4z 2/2 Running 069s</span><br><span class="line">prometheus-adapter-5f46ccd66d-bbsns 1/1 Running 073s</span><br><span class="line">prometheus-k8s-0 3/3 Running 153s</span><br><span class="line">prometheus-k8s-1 3/3 Running 153s</span><br><span class="line">prometheus-operator-6d8b95b467-htx56 1/1 Running 074s</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl top pods -n monitoring</span><br><span class="line">NAME CPU(cores) MEMORY(bytes)</span><br><span class="line">alertmanager-main-0 0m 18Mi</span><br><span class="line">alertmanager-main-1 2m 20Mi</span><br><span class="line">alertmanager-main-2 0m 19Mi</span><br><span class="line">grafana-76b8d59b9b-nd6gk 4m 49Mi</span><br><span class="line">kube-state-metrics-67b7c5dc78-sktzg 11m 29Mi</span><br><span class="line">kube-state-metrics-959876458-cjtr5 9m 37Mi</span><br><span class="line">node-exporter-prsvf 4m 11Mi</span><br><span class="line">node-exporter-qdh6n 1m 20Mi</span><br><span class="line">node-exporter-z6h4z 5m 11Mi</span><br><span class="line">prometheus-adapter-5f46ccd66d-bbsns 0m 17Mi</span><br><span class="line">prometheus-k8s-0 15m 190Mi</span><br><span class="line">prometheus-k8s-1 6m 199Mi</span><br><span class="line">prometheus-operator-6d8b95b467-htx56 0m 20Mi</span><br><span class="line">08-4.kube-prometheus插件</span><br></pre></td></tr></table></figure>

<h3 id="访问-Prometheus-UI"><a href="#访问-Prometheus-UI" class="headerlink" title="访问 Prometheus UI"></a>访问 Prometheus UI</h3><p>启动代理：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl port-forward --address 0.0.0.0 svc/grafana -n monitoring 3000:3000</span><br><span class="line">Forwarding from 0.0.0.0:3000 -&gt; 3000</span><br></pre></td></tr></table></figure>

<p>浏览器访问：<a href="http://172.27.138.251:3000/" target="_blank" rel="noopener">http://172.27.138.251:3000/</a></p>
<p>用 admin/admin 登录：</p>
<h2 id="部署-EFK-插件"><a href="#部署-EFK-插件" class="headerlink" title="部署 EFK 插件"></a>部署 EFK 插件</h2><p>注意：</p>
<ol>
<li>如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s-01 节点上执行。</li>
<li>kuberntes 自带插件的 manifests yaml 文件使用 gcr.io 的 docker registry，国内被墙，需要手动替换为其它 registry 地址；</li>
<li>可以从微软中国提供的 gcr.io 免费代理下载被墙的镜像；</li>
</ol>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>将下载的 kubernetes-server-linux-amd64.tar.gz 解压后，再解压其中的 kubernetes-src.tar.gz 文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work/kubernetes/</span><br><span class="line">tar -xzvf kubernetes-src.tar.gz</span><br></pre></td></tr></table></figure>

<p>EFK 目录是  kubernetes/cluster/addons/fluentd-elasticsearch</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work/kubernetes/cluster/addons/fluentd-elasticsearch</span><br><span class="line">sed -i -e <span class="string">'s_quay.io_quay.azk8s.cn_'</span> es-statefulset.yaml <span class="comment"># 使用微软的Registry</span></span><br><span class="line">sed -i -e <span class="string">'s_quay.io_quay.azk8s.cn_'</span> fluentd-es-ds.yaml <span class="comment"># 使用微软的 Registry</span></span><br></pre></td></tr></table></figure>

<h3 id="执行定义文件"><a href="#执行定义文件" class="headerlink" title="执行定义文件"></a>执行定义文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/k8s/work/kubernetes/cluster/addons/fluentd-elasticsearch</span><br><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure>

<h3 id="检查执行结果"><a href="#检查执行结果" class="headerlink" title="检查执行结果"></a>检查执行结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all -n kube-system |grep -E <span class="string">'elasticsearch|fluentd|kibana'</span></span><br></pre></td></tr></table></figure>

<p>kibana Pod 第一次启动时会用较长时间(0-20分钟)来优化和 Cache 状态页面，可以 tailf该 Pod 的日志观察进度：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs kibana-logging-75888755d6-nw6bc -n kube-system -f</span><br></pre></td></tr></table></figure>

<p>注意：只有当 Kibana pod 启动完成后，浏览器才能查看 kibana dashboard，否则会被拒绝。</p>
<h3 id="通过-kubectl-proxy-访问-kibana"><a href="#通过-kubectl-proxy-访问-kibana" class="headerlink" title="通过 kubectl proxy 访问 kibana"></a>通过 kubectl proxy 访问 kibana</h3><p>创建代理：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl proxy --address=<span class="string">'172.27.138.251'</span> --port=8086 --accept-hosts=<span class="string">'^*$'</span></span><br><span class="line">Starting to serve on 172.27.138.251:8086</span><br></pre></td></tr></table></figure>

<p>浏览器访问 URL： <a href="http://172.27.138.251:8086/api/v1/namespaces/kube-system/services/kibana-logging/proxy" target="_blank" rel="noopener">http://172.27.138.251:8086/api/v1/namespaces/kube-system/services/kibana-logging/proxy</a></p>
<p>在 Management -&gt; Indices 页面创建一个 index（相当于 mysql 中的一个 database），选中  Index contains time-based events  ，使用默认的  logstash-*  pattern，点击  Create  ;</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" <i class="fa fa-tag"></i>k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/10/ha+kp/HAProxy%E5%9F%BA%E4%BA%8Ecookie%E5%AE%9E%E7%8E%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/" rel="prev" title="HAProxy基于cookie实现客户端会话保持">
      <i class="fa fa-chevron-left"></i> HAProxy基于cookie实现客户端会话保持
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
      
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#组件版本和配置策略"><span class="nav-number">1.</span> <span class="nav-text">组件版本和配置策略</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主要组件版本"><span class="nav-number">1.1.</span> <span class="nav-text">主要组件版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主要配置策略"><span class="nav-number">1.2.</span> <span class="nav-text">主要配置策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-apiserver："><span class="nav-number">1.2.1.</span> <span class="nav-text">kube-apiserver：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-controller-manager："><span class="nav-number">1.2.2.</span> <span class="nav-text">kube-controller-manager：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet："><span class="nav-number">1.2.3.</span> <span class="nav-text">kubelet：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-proxy："><span class="nav-number">1.2.4.</span> <span class="nav-text">kube-proxy：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群插件："><span class="nav-number">1.2.5.</span> <span class="nav-text">集群插件：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#初始化系统和全局变量"><span class="nav-number">1.3.</span> <span class="nav-text">初始化系统和全局变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划"><span class="nav-number">1.3.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置主机名"><span class="nav-number">1.3.2.</span> <span class="nav-text">设置主机名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加节点信任关系"><span class="nav-number">1.3.3.</span> <span class="nav-text">添加节点信任关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新-PATH-变量"><span class="nav-number">1.3.4.</span> <span class="nav-text">更新 PATH 变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装依赖包"><span class="nav-number">1.3.5.</span> <span class="nav-text">安装依赖包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭防火墙"><span class="nav-number">1.3.6.</span> <span class="nav-text">关闭防火墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭-swap-分区"><span class="nav-number">1.3.7.</span> <span class="nav-text">关闭 swap 分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭-SELinux"><span class="nav-number">1.3.8.</span> <span class="nav-text">关闭 SELinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化内核参数"><span class="nav-number">1.3.9.</span> <span class="nav-text">优化内核参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置系统时区"><span class="nav-number">1.3.10.</span> <span class="nav-text">设置系统时区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置系统时钟同步"><span class="nav-number">1.3.11.</span> <span class="nav-text">设置系统时钟同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看同步状态："><span class="nav-number">1.3.12.</span> <span class="nav-text">查看同步状态：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#输出："><span class="nav-number">1.3.12.1.</span> <span class="nav-text">输出：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建相关目录"><span class="nav-number">1.3.13.</span> <span class="nav-text">创建相关目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建目录："><span class="nav-number">1.3.13.1.</span> <span class="nav-text">创建目录：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建环境变量文件"><span class="nav-number">1.3.14.</span> <span class="nav-text">创建环境变量文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发集群配置参数脚本"><span class="nav-number">1.3.15.</span> <span class="nav-text">分发集群配置参数脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#升级内核"><span class="nav-number">1.3.16.</span> <span class="nav-text">升级内核</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案如下："><span class="nav-number">1.3.16.1.</span> <span class="nav-text">解决方案如下：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#这里采用升级内核的解决办法："><span class="nav-number">1.3.16.2.</span> <span class="nav-text">这里采用升级内核的解决办法：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重启机器："><span class="nav-number">1.3.16.3.</span> <span class="nav-text">重启机器：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考"><span class="nav-number">1.3.16.4.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建-CA-根证书和秘钥"><span class="nav-number">2.</span> <span class="nav-text">创建 CA 根证书和秘钥</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-cfssl-工具集"><span class="nav-number">2.1.</span> <span class="nav-text">安装 cfssl 工具集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建配置文件"><span class="nav-number">2.2.</span> <span class="nav-text">创建配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建证书签名请求文件"><span class="nav-number">2.3.</span> <span class="nav-text">创建证书签名请求文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生成-CA-证书和私钥"><span class="nav-number">2.4.</span> <span class="nav-text">生成 CA 证书和私钥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分发证书文件"><span class="nav-number">2.5.</span> <span class="nav-text">分发证书文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装和配置-kubectl"><span class="nav-number">3.</span> <span class="nav-text">安装和配置 kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#下载和分发-kubectl-二进制文件"><span class="nav-number">3.1.</span> <span class="nav-text">下载和分发 kubectl 二进制文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分发到所有使用-kubectl-工具的节点："><span class="nav-number">3.1.1.</span> <span class="nav-text">分发到所有使用 kubectl 工具的节点：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建-admin-证书和私钥"><span class="nav-number">3.2.</span> <span class="nav-text">创建 admin 证书和私钥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建证书签名请求："><span class="nav-number">3.2.1.</span> <span class="nav-text">创建证书签名请求：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成证书和私钥："><span class="nav-number">3.2.2.</span> <span class="nav-text">生成证书和私钥：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建-kubeconfig-文件"><span class="nav-number">3.3.</span> <span class="nav-text">创建 kubeconfig 文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分发-kubeconfig-文件"><span class="nav-number">3.4.</span> <span class="nav-text">分发 kubeconfig 文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分发到所有使用-kubectl-命令的节点："><span class="nav-number">3.4.1.</span> <span class="nav-text">分发到所有使用  kubectl  命令的节点：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署-etcd-集群"><span class="nav-number">4.</span> <span class="nav-text">部署 etcd 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#下载和分发-etcd-二进制文件"><span class="nav-number">4.1.</span> <span class="nav-text">下载和分发 etcd 二进制文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#到-etcd-的-release-页面-下载最新版本的发布包："><span class="nav-number">4.1.1.</span> <span class="nav-text">到 etcd 的 release 页面 下载最新版本的发布包：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发二进制文件到集群所有节点："><span class="nav-number">4.1.2.</span> <span class="nav-text">分发二进制文件到集群所有节点：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建-etcd-证书和私钥"><span class="nav-number">4.2.</span> <span class="nav-text">创建 etcd 证书和私钥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建证书签名请求：-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">创建证书签名请求：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成证书和私钥：-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">生成证书和私钥：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发生成的证书和私钥到各-etcd-节点："><span class="nav-number">4.2.3.</span> <span class="nav-text">分发生成的证书和私钥到各 etcd 节点：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-etcd-的-systemd-unit-模板文件"><span class="nav-number">4.2.4.</span> <span class="nav-text">创建 etcd 的 systemd unit 模板文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为各节点创建和分发-etcd-systemd-unit-文件"><span class="nav-number">4.2.5.</span> <span class="nav-text">为各节点创建和分发 etcd systemd unit 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-etcd-服务"><span class="nav-number">4.2.6.</span> <span class="nav-text">启动 etcd 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查启动结果"><span class="nav-number">4.2.7.</span> <span class="nav-text">检查启动结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证服务状态"><span class="nav-number">4.2.8.</span> <span class="nav-text">验证服务状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看当前的-leader"><span class="nav-number">4.2.9.</span> <span class="nav-text">查看当前的 leader</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署-master-节点"><span class="nav-number">5.</span> <span class="nav-text">部署 master 节点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#下载最新版本二进制文件"><span class="nav-number">5.1.</span> <span class="nav-text">下载最新版本二进制文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载二进制-tar-文件并解压："><span class="nav-number">5.1.1.</span> <span class="nav-text">下载二进制 tar 文件并解压：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将二进制文件拷贝到所有-master-节点："><span class="nav-number">5.1.2.</span> <span class="nav-text">将二进制文件拷贝到所有 master 节点：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-kube-apiserver-集群"><span class="nav-number">5.2.</span> <span class="nav-text">部署 kube-apiserver 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kubernetes-master-证书和私钥"><span class="nav-number">5.2.1.</span> <span class="nav-text">创建 kubernetes-master 证书和私钥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建证书签名请求：-2"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">创建证书签名请求：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建加密配置文件"><span class="nav-number">5.2.2.</span> <span class="nav-text">创建加密配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#将加密配置文件拷贝到-master-节点的-etc-kubernetes-目录下："><span class="nav-number">5.2.2.1.</span> <span class="nav-text">将加密配置文件拷贝到 master 节点的  &#x2F;etc&#x2F;kubernetes  目录下：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建审计策略文件"><span class="nav-number">5.2.3.</span> <span class="nav-text">创建审计策略文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分发审计策略文件："><span class="nav-number">5.2.3.1.</span> <span class="nav-text">分发审计策略文件：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建后续访问-metrics-server-或-kube-prometheus使用的证书"><span class="nav-number">5.2.4.</span> <span class="nav-text">创建后续访问 metrics-server 或 kube-prometheus使用的证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建证书签名请求"><span class="nav-number">5.2.4.1.</span> <span class="nav-text">创建证书签名请求:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成证书和私钥：-2"><span class="nav-number">5.2.4.2.</span> <span class="nav-text">生成证书和私钥：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#将生成的证书和私钥文件拷贝到所有-master-节点："><span class="nav-number">5.2.4.3.</span> <span class="nav-text">将生成的证书和私钥文件拷贝到所有 master 节点：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kube-apiserver-systemd-unit-模板文件"><span class="nav-number">5.2.5.</span> <span class="nav-text">创建 kube-apiserver systemd unit 模板文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为各节点创建和分发-kube-apiserver-systemd-unit文件"><span class="nav-number">5.2.6.</span> <span class="nav-text">为各节点创建和分发 kube-apiserver systemd unit文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#替换模板文件中的变量，为各节点生成-systemd-unit-文件："><span class="nav-number">5.2.6.1.</span> <span class="nav-text">替换模板文件中的变量，为各节点生成 systemd unit 文件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分发生成的-systemd-unit-文件："><span class="nav-number">5.2.6.2.</span> <span class="nav-text">分发生成的 systemd unit 文件：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查-kube-apiserver-运行状态"><span class="nav-number">5.2.7.</span> <span class="nav-text">检查 kube-apiserver 运行状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查集群状态"><span class="nav-number">5.2.8.</span> <span class="nav-text">检查集群状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查-kube-apiserver-监听的端口"><span class="nav-number">5.2.9.</span> <span class="nav-text">检查 kube-apiserver 监听的端口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署高可用-kube-controller-manager-集群"><span class="nav-number">5.3.</span> <span class="nav-text">部署高可用 kube-controller-manager 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kube-controller-manager-证书和私钥"><span class="nav-number">5.3.1.</span> <span class="nav-text">创建 kube-controller-manager 证书和私钥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建证书签名请求：-3"><span class="nav-number">5.3.1.1.</span> <span class="nav-text">创建证书签名请求：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成证书和私钥：-3"><span class="nav-number">5.3.1.2.</span> <span class="nav-text">生成证书和私钥：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#将生成的证书和私钥分发到所有-master-节点："><span class="nav-number">5.3.1.3.</span> <span class="nav-text">将生成的证书和私钥分发到所有 master 节点：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和分发-kubeconfig-文件"><span class="nav-number">5.3.2.</span> <span class="nav-text">创建和分发 kubeconfig 文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分发-kubeconfig-到所有-master-节点："><span class="nav-number">5.3.2.1.</span> <span class="nav-text">分发 kubeconfig 到所有 master 节点：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kube-controller-manager-systemd-unit-模板文件"><span class="nav-number">5.3.3.</span> <span class="nav-text">创建 kube-controller-manager systemd unit 模板文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为各节点创建和分发-kube-controller-manangersystemd-unit-文件"><span class="nav-number">5.3.4.</span> <span class="nav-text">为各节点创建和分发 kube-controller-manangersystemd unit 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-kube-controller-manager-服务"><span class="nav-number">5.3.5.</span> <span class="nav-text">启动 kube-controller-manager 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查服务运行状态"><span class="nav-number">5.3.6.</span> <span class="nav-text">检查服务运行状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看输出的-metrics"><span class="nav-number">5.3.7.</span> <span class="nav-text">查看输出的 metrics</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看当前的-leader-1"><span class="nav-number">5.3.8.</span> <span class="nav-text">查看当前的 leader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试-kube-controller-manager-集群的高可用"><span class="nav-number">5.3.9.</span> <span class="nav-text">测试 kube-controller-manager 集群的高可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考-1"><span class="nav-number">5.3.10.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署高可用-kube-scheduler-集群"><span class="nav-number">5.4.</span> <span class="nav-text">部署高可用 kube-scheduler 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kube-scheduler-证书和私钥"><span class="nav-number">5.4.1.</span> <span class="nav-text">创建 kube-scheduler 证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和分发-kubeconfig-文件-1"><span class="nav-number">5.4.2.</span> <span class="nav-text">创建和分发 kubeconfig 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kube-scheduler-配置文件"><span class="nav-number">5.4.3.</span> <span class="nav-text">创建 kube-scheduler 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kube-scheduler-systemd-unit-模板文件"><span class="nav-number">5.4.4.</span> <span class="nav-text">创建 kube-scheduler systemd unit 模板文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为各节点创建和分发-kube-scheduler-systemd-unit文件"><span class="nav-number">5.4.5.</span> <span class="nav-text">为各节点创建和分发 kube-scheduler systemd unit文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-kube-scheduler-服务"><span class="nav-number">5.4.6.</span> <span class="nav-text">启动 kube-scheduler 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查服务运行状态-1"><span class="nav-number">5.4.7.</span> <span class="nav-text">检查服务运行状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看输出的-metrics-1"><span class="nav-number">5.4.8.</span> <span class="nav-text">查看输出的 metrics</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看当前的-leader-2"><span class="nav-number">5.4.9.</span> <span class="nav-text">查看当前的 leader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试-kube-scheduler-集群的高可用"><span class="nav-number">5.4.10.</span> <span class="nav-text">测试 kube-scheduler 集群的高可用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署-worker-节点"><span class="nav-number">6.</span> <span class="nav-text">部署 worker 节点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装依赖包-1"><span class="nav-number">6.1.</span> <span class="nav-text">安装依赖包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#apiserver-高可用"><span class="nav-number">6.2.</span> <span class="nav-text">apiserver 高可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下载和编译-nginx"><span class="nav-number">6.3.</span> <span class="nav-text">下载和编译 nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置编译参数："><span class="nav-number">6.3.1.</span> <span class="nav-text">配置编译参数：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译和安装："><span class="nav-number">6.3.2.</span> <span class="nav-text">编译和安装：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证编译的-nginx"><span class="nav-number">6.3.3.</span> <span class="nav-text">验证编译的 nginx</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装和部署-nginx"><span class="nav-number">6.4.</span> <span class="nav-text">安装和部署 nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建目录结构："><span class="nav-number">6.4.1.</span> <span class="nav-text">创建目录结构：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝二进制程序："><span class="nav-number">6.4.2.</span> <span class="nav-text">拷贝二进制程序：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-nginx，开启-4-层透明转发功能："><span class="nav-number">6.4.3.</span> <span class="nav-text">配置 nginx，开启 4 层透明转发功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-systemd-unit-文件，启动服务"><span class="nav-number">6.4.4.</span> <span class="nav-text">配置 systemd unit 文件，启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发-systemd-unit-文件："><span class="nav-number">6.4.5.</span> <span class="nav-text">分发 systemd unit 文件：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-kube-nginx-服务："><span class="nav-number">6.4.6.</span> <span class="nav-text">启动 kube-nginx 服务：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查-kube-nginx-服务运行状态"><span class="nav-number">6.4.7.</span> <span class="nav-text">检查 kube-nginx 服务运行状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-containerd-组件"><span class="nav-number">6.5.</span> <span class="nav-text">部署 containerd 组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载和分发二进制文件"><span class="nav-number">6.5.1.</span> <span class="nav-text">下载和分发二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和分发-containerd-配置文件"><span class="nav-number">6.5.2.</span> <span class="nav-text">创建和分发 containerd 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-containerd-systemd-unit-文件"><span class="nav-number">6.5.3.</span> <span class="nav-text">创建 containerd systemd unit 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发-systemd-unit-文件，启动-containerd-服务"><span class="nav-number">6.5.4.</span> <span class="nav-text">分发 systemd unit 文件，启动 containerd 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和分发-crictl-配置文件"><span class="nav-number">6.5.5.</span> <span class="nav-text">创建和分发 crictl 配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-kubelet-组件"><span class="nav-number">6.6.</span> <span class="nav-text">部署 kubelet 组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载和分发-kubelet-二进制文件"><span class="nav-number">6.6.1.</span> <span class="nav-text">下载和分发 kubelet 二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kubelet-bootstrap-kubeconfig-文件"><span class="nav-number">6.6.2.</span> <span class="nav-text">创建 kubelet bootstrap kubeconfig 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发-bootstrap-kubeconfig-文件到所有-worker-节点"><span class="nav-number">6.6.3.</span> <span class="nav-text">分发 bootstrap kubeconfig 文件到所有 worker 节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和分发-kubelet-参数配置文件"><span class="nav-number">6.6.4.</span> <span class="nav-text">创建和分发 kubelet 参数配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和分发-kubelet-systemd-unit-文件"><span class="nav-number">6.6.5.</span> <span class="nav-text">创建和分发 kubelet systemd unit 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授予-kube-apiserver-访问-kubelet-API-的权限"><span class="nav-number">6.6.6.</span> <span class="nav-text">授予 kube-apiserver 访问 kubelet API 的权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bootstrap-Token-Auth-和授予权限"><span class="nav-number">6.6.7.</span> <span class="nav-text">Bootstrap Token Auth 和授予权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动-approve-CSR-请求，生成-kubelet-client-证书"><span class="nav-number">6.6.8.</span> <span class="nav-text">自动 approve CSR 请求，生成 kubelet client 证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-kubelet-服务"><span class="nav-number">6.6.9.</span> <span class="nav-text">启动 kubelet 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看-kubelet-情况"><span class="nav-number">6.6.10.</span> <span class="nav-text">查看 kubelet 情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动-approve-server-cert-csr"><span class="nav-number">6.6.11.</span> <span class="nav-text">手动 approve server cert csr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet-api-认证和授权"><span class="nav-number">6.6.12.</span> <span class="nav-text">kubelet api 认证和授权</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#证书认证和授权"><span class="nav-number">6.6.12.1.</span> <span class="nav-text">证书认证和授权</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bear-token-认证和授权"><span class="nav-number">6.6.13.</span> <span class="nav-text">bear token 认证和授权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cadvisor-和-metrics"><span class="nav-number">6.6.14.</span> <span class="nav-text">cadvisor 和 metrics</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考-2"><span class="nav-number">6.6.15.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-kube-proxy-组件"><span class="nav-number">6.7.</span> <span class="nav-text">部署 kube-proxy 组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载和分发-kube-proxy-二进制文件"><span class="nav-number">6.7.1.</span> <span class="nav-text">下载和分发 kube-proxy 二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kube-proxy-证书"><span class="nav-number">6.7.2.</span> <span class="nav-text">创建 kube-proxy 证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和分发-kubeconfig-文件-2"><span class="nav-number">6.7.3.</span> <span class="nav-text">创建和分发 kubeconfig 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-kube-proxy-配置文件"><span class="nav-number">6.7.4.</span> <span class="nav-text">创建 kube-proxy 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和分发-kube-proxy-systemd-unit-文件"><span class="nav-number">6.7.5.</span> <span class="nav-text">创建和分发 kube-proxy systemd unit 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-kube-proxy-服务"><span class="nav-number">6.7.6.</span> <span class="nav-text">启动 kube-proxy 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查启动结果-1"><span class="nav-number">6.7.7.</span> <span class="nav-text">检查启动结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看监听端口"><span class="nav-number">6.7.8.</span> <span class="nav-text">查看监听端口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-calico-网络"><span class="nav-number">6.8.</span> <span class="nav-text">部署 calico 网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-calico-网络插件"><span class="nav-number">6.8.1.</span> <span class="nav-text">安装 calico 网络插件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#验证集群功能"><span class="nav-number">7.</span> <span class="nav-text">验证集群功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#检查节点状态"><span class="nav-number">7.1.</span> <span class="nav-text">检查节点状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建测试文件"><span class="nav-number">7.2.</span> <span class="nav-text">创建测试文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#执行测试"><span class="nav-number">7.2.1.</span> <span class="nav-text">执行测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查服务-IP-和端口可达性"><span class="nav-number">7.3.</span> <span class="nav-text">检查服务 IP 和端口可达性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查服务的-NodePort-可达性"><span class="nav-number">7.4.</span> <span class="nav-text">检查服务的 NodePort 可达性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署集群插件"><span class="nav-number">8.</span> <span class="nav-text">部署集群插件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-coredns-插件"><span class="nav-number">8.1.</span> <span class="nav-text">部署 coredns 插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载和配置-coredns"><span class="nav-number">8.1.1.</span> <span class="nav-text">下载和配置 coredns</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-coredns"><span class="nav-number">8.1.2.</span> <span class="nav-text">创建 coredns</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查-coredns-功能"><span class="nav-number">8.1.3.</span> <span class="nav-text">检查 coredns 功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#新建一个-Deployment："><span class="nav-number">8.1.3.1.</span> <span class="nav-text">新建一个 Deployment：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考-3"><span class="nav-number">8.1.4.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-dashboard-插件"><span class="nav-number">8.2.</span> <span class="nav-text">部署 dashboard 插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载和修改配置文件"><span class="nav-number">8.2.1.</span> <span class="nav-text">下载和修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行所有定义文件"><span class="nav-number">8.2.2.</span> <span class="nav-text">执行所有定义文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看运行状态"><span class="nav-number">8.2.3.</span> <span class="nav-text">查看运行状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问-dashboard"><span class="nav-number">8.2.4.</span> <span class="nav-text">访问 dashboard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-port-forward-访问-dashboard"><span class="nav-number">8.2.5.</span> <span class="nav-text">通过 port forward 访问 dashboard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建登录-Dashboard-的-token-和-kubeconfig-配置文件"><span class="nav-number">8.2.6.</span> <span class="nav-text">创建登录 Dashboard 的 token 和 kubeconfig 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建登录-token"><span class="nav-number">8.2.6.1.</span> <span class="nav-text">创建登录 token</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建使用-token-的-KubeConfig-文件"><span class="nav-number">8.2.7.</span> <span class="nav-text">创建使用 token 的 KubeConfig 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考-4"><span class="nav-number">8.2.8.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-kube-prometheus-插架"><span class="nav-number">8.3.</span> <span class="nav-text">部署 kube-prometheus 插架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载和安装"><span class="nav-number">8.3.1.</span> <span class="nav-text">下载和安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看运行状态-1"><span class="nav-number">8.3.2.</span> <span class="nav-text">查看运行状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问-Prometheus-UI"><span class="nav-number">8.3.3.</span> <span class="nav-text">访问 Prometheus UI</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-EFK-插件"><span class="nav-number">8.4.</span> <span class="nav-text">部署 EFK 插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改配置文件"><span class="nav-number">8.4.1.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行定义文件"><span class="nav-number">8.4.2.</span> <span class="nav-text">执行定义文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查执行结果"><span class="nav-number">8.4.3.</span> <span class="nav-text">检查执行结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-kubectl-proxy-访问-kibana"><span class="nav-number">8.4.4.</span> <span class="nav-text">通过 kubectl proxy 访问 kibana</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">屈辉</p>
  <div class="site-description" itemprop="description">开心就好</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">屈辉</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.1
  </div> -->

        








      </div>
    </footer>
  </div>

  
  
  <script color='3423,34,234' opacity='0.35' zIndex='-1' count='150' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
